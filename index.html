<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kirill's Integrated System v2 (Fixed)</title>
    
    <!-- 默认字体链接 (会被JS动态管理) -->
    <div id="font-link-container">
        <link rel="preload" as="style" crossorigin
            href="https://fontsapi.zeoseven.com/309/main/result.css"
            onload="this.rel='stylesheet'"
            onerror="this.href='httpsapi-storage.zeoseven.com/309/main/result.css'" />
        <noscript>
            <link rel="stylesheet" href="https://fontsapi.zeoseven.com/309/main/result.css" />
        </noscript>
    </div>
    <!-- 动态字体样式注入点 -->
    <style id="dynamic-font-style"></style>

    <style>
        /* --- 全局CSS变量定义 (由JS动态控制) --- */
        :root {
            --screen-bg: #f7f9f7;
            --card-bg: #ffffff;
            --border-color: #e0e6e1;
            --danger-color: #e57373;
            --battery-low: #e74c3c;
            --battery-charging: #34c759;
            
            --text-color-fixed: #333333;
            --text-light-fixed: #888888;

            /* 主题色相关 (会被JS覆盖) */
            --placeholder-bg: #e8f0e9;
            --screen-bg-themed: #eef2ee;
            --accent-color: #5a6e60; 
            --dock-bg: rgba(232, 240, 233, 0.85);

            /* 字体相关 (会被JS覆盖) */
            --font-main: "KingHwaOldSong", 'Songti SC', 'STSong', 'SimSun', serif;
            --global-font-size: 16px; 
            --global-font-weight: 400;
        }

        /* --- 基础与布局 --- */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--placeholder-bg);
            font-family: var(--font-main);
            color: var(--text-color-fixed);
            overflow: hidden;
            font-size: var(--global-font-size);
            font-weight: var(--global-font-weight);
            display: flex; justify-content: center; align-items: center;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container { 
            width: 100%; height: 100%; 
            max-width: 420px; max-height: 850px; 
            display: flex; flex-direction: column; 
            overflow: hidden; position: relative; 
            background-color: var(--screen-bg);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border-radius: 20px;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            transition: background-image 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }

        .app-container.has-wallpaper .page {
            background-color: transparent;
        }

        /* --- 页面切换与布局修正 --- */
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; background-color: var(--screen-bg);
            opacity: 0; visibility: hidden;
            transition: opacity 0.4s cubic-bezier(0.65, 0, 0.35, 1), transform 0.4s cubic-bezier(0.65, 0, 0.35, 1), background-color 0.3s ease-in-out;
            transform: scale(1.05); z-index: 1;
            padding-top: 50px;
            box-sizing: border-box;
        }
        .page.active { opacity: 1; visibility: visible; z-index: 10; transform: scale(1); }
        .page.exit-to-background { transform: scale(0.95); opacity: 0; z-index: 9; }

        /* --- 通用内容区域 --- */
        .app-content-area { flex-grow: 1; overflow-y: auto; }
        .app-content-area::-webkit-scrollbar { display: none; }
        .app-content-area.padded { padding: 20px; box-sizing: border-box; }

        /* --- 通用弹窗样式 --- */
        .custom-prompt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        .custom-prompt-overlay.visible { opacity: 1; visibility: visible; }
        .custom-prompt-box { background-color: var(--screen-bg); padding: 25px; border-radius: 15px; width: 80%; max-width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.95) translateY(10px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .custom-prompt-overlay.visible .custom-prompt-box { transform: scale(1) translateY(0); }
        .custom-prompt-box h3 { margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-color-fixed); }
        .custom-prompt-box p { margin: 0 0 15px; font-size: 0.9em; line-height: 1.6; color: var(--text-color-fixed); }
        .custom-prompt-box .input-field, .custom-prompt-box .textarea-field, .custom-prompt-box .select-field { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; box-sizing: border-box; font-family: var(--font-main); font-size: 0.9em; background-color: #fff; color: var(--text-color-fixed); }
        .custom-prompt-box .input-field:focus, .custom-prompt-box .textarea-field:focus, .custom-prompt-box .select-field:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 25%, transparent); }
        .custom-prompt-box label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9em; }
        .custom-prompt-box .form-group { margin-bottom: 15px; }
        .custom-prompt-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .custom-prompt-buttons .btn { padding: 8px 20px; background-color: var(--placeholder-bg); border: none; border-radius: 10px; font-family: var(--font-main); color: var(--text-color-fixed); font-size: 0.9em; cursor: pointer; }
        .custom-prompt-buttons .btn-primary { background-color: var(--accent-color); color: white; }
        .custom-prompt-buttons .btn-danger { background-color: var(--danger-color); color: white; }

        /* --- START: 桌面 & 状态栏 CSS --- */
        .status-bar { padding: 15px 25px 10px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; box-sizing: border-box; position: absolute; top: 0; left: 0; right: 0; z-index: 200; height: 50px; }
        .status-bar-time { font-weight: 600; font-size: 15px; }
        .status-bar-right-icons { display: flex; align-items: center; gap: 7px; color: var(--text-color-fixed); }
        .status-bar-right-icons svg { height: 13px; width: auto; }
        .status-bar-svg-icon path, .status-bar-svg-icon rect, .status-bar-svg-icon circle { fill: currentColor; }
        .battery-container { display: flex; align-items: center; height: 13px; }
        .battery-frame { stroke: currentColor; stroke-width: 1px; fill: none; }
        .battery-terminal { fill: currentColor; }
        .battery-fill { fill: currentColor; }
        .battery-low { color: var(--danger-color); }
        .battery-low .battery-fill { fill: var(--danger-color); }
        #battery-charging-bolt { display: none; }
        .battery-charging #battery-charging-bolt { display: block; }
        .battery-charging .battery-bolt-path { fill: var(--card-bg); }
        .battery-charging .battery-fill { fill: var(--battery-charging); display: block !important; }
        #api-status-indicator circle { transition: fill 0.4s ease-in-out; }
        body.api-connected #api-status-indicator circle { fill: var(--battery-charging); }
        body.api-disconnected #api-status-indicator circle { fill: var(--danger-color); }

        #desktop-page { padding-top: 0; }
        .main-content { flex-grow: 1; padding: 0 20px; display: flex; flex-direction: column; overflow-y: auto; }
        .main-content::-webkit-scrollbar { display: none; }
        .profile-card { position: relative; margin-top: 60px; flex-shrink: 0; background-color: var(--card-bg); border-radius: 20px; box-shadow: 0 8px 25px rgba(90, 110, 96, 0.1); }
        .profile-banner { height: 120px; background-color: var(--placeholder-bg); border-radius: 20px 20px 0 0; cursor: pointer; background-size: cover; background-position: center; }
        .avatar-frame { width: 85px; height: 85px; position: absolute; top: 120px; left: 50%; transform: translate(-50%, -55%); z-index: 10; display: flex; justify-content: center; align-items: center; }
        .avatar { width: 75px; height: 75px; background-color: var(--card-bg); border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease; background-size: cover; background-position: center; background-repeat: no-repeat; }
        .avatar:hover { transform: scale(1.05); }
        .avatar.avatar-framed { width: 65px; height: 65px; }
        #avatar-frame-overlay { position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 50%; pointer-events: none; transition: background-image 0.3s, box-shadow 0.3s; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .profile-info { text-align: center; padding: 50px 15px 20px; }
        .profile-info .editable { cursor: pointer; }
        .profile-info .editable:hover { opacity: 0.7; }
        .profile-info .nickname, .profile-info .username, .profile-info .bio, .profile-info .location span { min-height: 1em; }
        .profile-info .nickname { font-size: 1.125em; font-weight: bold; margin: 0 0 4px; }
        .profile-info .username { font-size: 0.8125em; color: var(--text-light-fixed); margin: 0; }
        .profile-info .bio { font-size: 0.8125em; margin: 12px 0; letter-spacing: 1px; }
        .profile-info .location { display: inline-flex; align-items: center; gap: 5px; font-size: 0.75em; color: var(--text-light-fixed); background-color: var(--screen-bg); padding: 4px 10px; border-radius: 20px; margin-top: 5px; }
        .profile-info .location svg { width: 12px; height: 12px; flex-shrink: 0; }
        .middle-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; min-height: 150px; }
        .main-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: stretch; height: 130px; width: 100%; flex-shrink: 0; }
        .widget-card-vertical { background-color: var(--card-bg); border-radius: 18px; cursor: pointer; background-size: cover; background-position: center; }
        .app-grid-right { display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); gap: 15px; }
        .app-icon { text-decoration: none; color: var(--text-color-fixed); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; transition: transform 0.2s ease; }
        .app-icon:hover { transform: scale(1.08); }
        .icon-placeholder { width: 75%; padding-top: 75%; position: relative; background-color: var(--card-bg); border-radius: 14px; background-size: cover; background-position: center; }
        .app-icon span { font-size: 0.6875em; }
        .dock { padding: 15px 20px; margin: 15px; background-color: var(--dock-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 25px; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; transition: background-color 0.3s ease; }
        .dock-icon { cursor: pointer; }
        .dock-icon-placeholder { width: 50px; height: 50px; background-color: white; border-radius: 12px; cursor: pointer; background-size: cover; background-position: center; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 15px; width: 80%; max-width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal-content h3 { margin-top: 0; color: var(--text-color-fixed); }
        .modal-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-family: var(--font-main); margin-bottom: 15px; transition: border-color 0.2s, box-shadow 0.2s; color: var(--text-color-fixed); }
        .modal-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 5px color-mix(in srgb, var(--accent-color) 25%, transparent); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-button { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-family: var(--font-main); }
        .modal-button.save { background-color: var(--accent-color); color: white; }
        .modal-button.cancel { background-color: #eee; color: #333; }
        /* --- END: 桌面 & 状态栏 CSS --- */
        
        /* --- START: 通用APP头部与按钮 --- */
        .app-header-generic { padding: 15px 20px; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; border-bottom: 1px solid var(--border-color); z-index: 5; }
        .app-title-generic { font-size: 1.1em; font-weight: bold; max-width: calc(100% - 120px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-btn-generic { position: absolute; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; color: var(--text-color-fixed); font-family: var(--font-main); }
        .header-btn-generic svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 1.5; }
        .back-button-generic { left: 15px; }
        .right-header-btn-generic { right: 15px; font-size: 1em; font-weight: bold; color: var(--accent-color); }
        .header-actions-generic { position: absolute; right: 20px; display: flex; gap: 10px; }
        .action-button-generic { background-color: var(--placeholder-bg); width: 32px; height: 32px; border: none; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; color: var(--accent-color); transition: background-color 0.2s; }
        .action-button-generic:hover { background-color: color-mix(in srgb, var(--placeholder-bg) 80%, black); }
        .action-button-generic svg { width: 20px; height: 20px; stroke-width: 2; }
        .dropdown-menu-generic { position: absolute; top: calc(100% + 8px); background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 5px 20px rgba(90, 110, 96, 0.15); width: 160px; overflow: hidden; z-index: 100; opacity: 0; visibility: hidden; transition: all 0.2s ease; }
        .dropdown-menu-generic.right-aligned { right: 0; transform: translateY(-10px); }
        .dropdown-menu-generic.right-aligned.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        .dropdown-item-generic { display: block; padding: 12px 15px; font-size: 0.9em; color: var(--text-color-fixed); text-decoration: none; transition: background-color 0.2s; cursor: pointer; }
        .dropdown-item-generic:hover { background-color: var(--placeholder-bg); }
        .dropdown-divider-generic { border-top: 1px solid var(--border-color); margin: 4px 0; }
        .app-title-generic.clickable { cursor: pointer; transition: color 0.2s; }
        .app-title-generic.clickable:hover { color: var(--accent-color); }
        /* --- END: 通用APP头部与按钮 --- */

        /* --- START: 美化APP & 子页面 CSS --- */
        .setting-card { background-color: var(--card-bg); border-radius: 15px; padding: 18px 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: 0 4px 15px rgba(90, 110, 96, 0.08); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .setting-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(90, 110, 96, 0.12); }
        .setting-card span { font-size: 0.9375em; }
        .setting-card .arrow { color: var(--text-light-fixed); font-size: 1.125em; }
        .settings-section { background-color: var(--card-bg); border-radius: 15px; padding: 15px 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(90, 110, 96, 0.08); }
        .settings-section h3 { font-size: 1em; margin: 0 0 15px 0; }
        .control-group { margin-bottom: 15px; }
        .control-group:last-child { margin-bottom: 5px; }
        .control-group label { display: block; font-size: 0.875em; margin-bottom: 8px; color: var(--text-light-fixed); }
        .btn { display: block; width: 100%; padding: 10px; background-color: var(--placeholder-bg); border: none; border-radius: 8px; font-family: var(--font-main); color: var(--text-color-fixed); font-size: 0.9375em; cursor: pointer; text-align: center; }
        .input-field, .textarea-field, .select-field { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-family: var(--font-main); font-size: 0.875em; background-color: #fdfdfd; color: var(--text-color-fixed); }
        .textarea-field { resize: vertical; min-height: 150px; }
        .slider-container { display: flex; align-items: center; gap: 15px; }
        .slider-container span { font-size: 0.875em; color: var(--text-light-fixed); }
        input[type="range"] { flex-grow: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 5px; background: var(--placeholder-bg); border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--accent-color); border-radius: 50%; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; background: var(--accent-color); border-radius: 50%; cursor: pointer; }
        .preview-box { background-color: var(--placeholder-bg); padding: 20px; border-radius: 10px; text-align: center; }
        #font-preview { font-size: 1.5em; font-weight: bold; margin-bottom: 10px !important; }
        #font-details { font-size: 0.8em; color: var(--text-light-fixed); }
        #wallpaper-preview { width: 140px; height: 280px; margin: 0 auto; background-color: var(--placeholder-bg); border-radius: 15px; border: 3px solid var(--card-bg); box-shadow: 0 4px 10px rgba(0,0,0,0.1); background-size: cover; background-repeat: no-repeat; background-position: center; transition: background-image 0.3s ease-in-out; display: flex; justify-content: center; align-items: center; color: var(--text-light-fixed); font-size: 0.9em; }
        .settings-section label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.875em; margin-bottom: 10px; }
        .settings-section label input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-color); }
        .icon-setting-group { margin-bottom: 25px; }
        .icon-setting-group h4 { font-size: 0.9em; margin: 0 0 10px; color: var(--text-color-fixed); border-bottom: 1px solid var(--placeholder-bg); padding-bottom: 8px; }
        .icon-setting-group .control-group { display: flex; gap: 10px; }
        .icon-setting-group .control-group .btn { width: auto; flex-grow: 1; }
        .icon-setting-group .control-group .input-field { width: auto; flex-grow: 2; }
        .btn-restore { background-color: #e8e8e8; margin-top: 10px; }
        #theme-color-preview { width: 80px; height: 80px; border-radius: 50%; background-color: var(--placeholder-bg); border: 4px solid var(--card-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: background-color 0.3s; margin: 0 auto 20px; }
        #theme-color-hex { font-family: monospace; text-transform: uppercase; text-align: center; }
        .saved-font-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background-color: var(--placeholder-bg); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s, transform 0.2s; font-size: 0.9375em; }
        .saved-font-item:hover { background-color: color-mix(in srgb, var(--placeholder-bg) 80%, black); transform: scale(1.02); }
        .saved-font-name { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; }
        .delete-font-btn { background: none; border: none; cursor: pointer; font-size: 1.5em; color: var(--text-light-fixed); padding: 0 5px; line-height: 1; transition: color 0.2s; }
        .delete-font-btn:hover { color: var(--danger-color); }
        #saved-fonts-toggle .arrow { transition: transform 0.3s ease; display: inline-block; }
        #saved-fonts-toggle.expanded .arrow { transform: rotate(180deg); }
        .avatar-frame-preview { position: relative; width: 85px; height: 85px; margin: 20px auto; display: flex; justify-content: center; align-items: center; }
        #preview-avatar { position: relative; } 
        #preview-avatar-frame { position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 50%; background-size: contain; background-repeat: no-repeat; background-position: center; }
        /* --- END: 美化APP CSS --- */

        /* --- START: API 配置APP CSS --- */
        #api-config-page .page-container { flex-grow: 1; overflow-y: auto; padding: 15px 20px; }
        #api-config-page .page-view { display: none; }
        #api-config-page .page-view.active { display: block; }
        #api-config-page .input-with-button { display: flex; align-items: center; gap: 10px; }
        #api-config-page .input-with-button .input-field { flex-grow: 1; }
        #api-config-page .input-with-button .btn-icon { padding: 10px; line-height: 0; background-color: var(--placeholder-bg); border-radius: 10px; cursor: pointer; border: none; }
        #api-config-page .input-with-button .btn-icon svg { width: 20px; height: 20px; fill: var(--accent-color); }
        #api-config-page #connection-status { margin-top: 15px; text-align: center; font-size: 0.9em; min-height: 1.2em; transition: color 0.3s; white-space: pre-wrap; word-break: break-all; }
        #api-config-page #connection-status.success { color: var(--battery-charging); }
        #api-config-page #connection-status.error { color: var(--danger-color); }
        #api-config-page .app-footer { flex-shrink: 0; display: flex; justify-content: space-around; padding: 10px 0; background-color: var(--card-bg); box-shadow: 0 -5px 20px rgba(90, 110, 96, 0.08); border-top: 1px solid var(--border-color); }
        #api-config-page .nav-btn { background: none; border: none; font-family: var(--font-main); font-size: 0.9em; color: var(--text-light-fixed); cursor: pointer; padding: 5px 15px; border-radius: 8px; transition: color 0.2s, background-color 0.2s; }
        #api-config-page .nav-btn.active { color: var(--accent-color); font-weight: bold; background-color: var(--placeholder-bg); }
        #api-config-page .preset-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background-color: #fdfdfd; border-radius: 10px; border: 1px solid var(--placeholder-bg); }
        #api-config-page .preset-name { font-weight: bold; margin-right: 15px; }
        #api-config-page .preset-actions { display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        #api-config-page .preset-actions .btn-sm { padding: 6px 12px; font-size: 0.85em; min-width: 60px; }
        #api-config-page .btn-delete { background-color: #fbeae8; color: var(--danger-color); }
        /* --- END: API 配置APP CSS --- */

        /* --- START: 角色书 & 世界书 通用与特定CSS --- */
        .empty-placeholder { text-align: center; color: var(--text-light-fixed); padding: 40px 20px; line-height: 1.6; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9em; color: var(--text-color-fixed); font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; box-sizing: border-box; font-family: var(--font-main); font-size: 1em; background-color: var(--card-bg); color: var(--text-color-fixed); transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 25%, transparent); }
        .form-group textarea { min-height: 100px; resize: vertical; font-size: 0.9em; line-height: 1.6; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .setting-item-label { display: flex; align-items: center; gap: 10px; }
        .setting-item:last-of-type { border-bottom: none; }
        .switch-container { position: relative; display: inline-block; width: 48px; height: 26px; }
        .switch-container input { opacity: 0; width: 0; height: 0; }
        .switch-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 26px; }
        .switch-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input:checked + .switch-slider { background-color: var(--accent-color); }
        input:checked + .switch-slider:before { transform: translateX(22px); }
        
        .list-group-header, .group-header { 
            font-size: 1em !important; 
            color: #888888 !important; 
            font-weight: 600 !important;
        }
        #char-list-page .list-group-header { display: flex; justify-content: space-between; align-items: center; margin: 20px 20px 10px 25px; text-transform: uppercase; cursor: pointer; }
        #char-list-page .list-group-header:first-of-type {
            margin-top: 10px;
        }
        #char-list-page .list-toggle-arrow { transition: transform 0.3s ease; }
        #char-list-page .list-card-container { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 0 20px; max-height: 2000px; overflow: hidden; transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out; opacity: 1; }
        #char-list-page .list-card-container.collapsed { max-height: 0; opacity: 0; }
        #char-list-page .list-group-header.collapsed .list-toggle-arrow { transform: rotate(-90deg); }
        .character-card { background-color: var(--card-bg); border-radius: 18px; padding: 18px; box-shadow: 0 4px 15px rgba(90, 110, 96, 0.08); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; }
        .character-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(90, 110, 96, 0.12); }
        .card-avatar { width: 56px; height: 56px; border-radius: 50%; background-color: var(--placeholder-bg); margin-right: 20px; flex-shrink: 0; background-size: cover; background-position: center; }
        .card-content { flex-grow: 1; overflow: hidden; }
        .card-title {
            font-size: 1.05em;
            font-weight: bold;
            margin: 0 0 8px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-color-fixed);
            word-break: break-all;
        }
        .card-description { font-size: 0.85em; color: var(--text-light-fixed); margin: 0; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .editor-content { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .avatar-uploader { text-align: center; margin-bottom: 25px; }
        .avatar-preview { width: 100px; height: 100px; border-radius: 50%; background-color: var(--placeholder-bg); margin: 0 auto 15px; background-size: cover; background-position: center; border: 3px solid var(--card-bg); box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; }
        .opening-text-container { margin-top: 15px; display: none; }
        .add-greeting-btn { background: none; border: none; font-family: var(--font-main); color: var(--accent-color); font-size: 0.9em; cursor: pointer; font-weight: bold; padding: 2px 5px; }
        .greeting-item { margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
        .greeting-item summary { padding: 10px 12px; background-color: var(--placeholder-bg); cursor: pointer; font-weight: bold; font-size: 0.9em; color: var(--accent-color); outline: none; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        .greeting-item summary::-webkit-details-marker { display: none; }
        .greeting-item summary .summary-title { flex-grow: 1; }
        .greeting-item summary .summary-controls { display: flex; align-items: center; gap: 8px; }
        .greeting-item summary .greeting-arrow { font-size: 0.8em; transition: transform 0.2s; }
        .greeting-item[open] summary .greeting-arrow { transform: rotate(90deg); }
        .greeting-item[open] summary { border-bottom: 1px solid var(--border-color); }
        .greeting-item textarea { width: 100%; border: none !important; border-radius: 0 !important; box-shadow: none !important; min-height: 80px; padding: 12px; box-sizing: border-box; }
        .delete-greeting-btn { background: transparent; border: none; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--text-light-fixed); transition: color 0.2s; }
        .delete-greeting-btn:hover { color: var(--danger-color); }
        .delete-greeting-btn svg { width: 18px; height: 18px; }
        .delete-button-container { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .delete-button { width: 100%; padding: 12px; background-color: transparent; border: 1px solid var(--danger-color); color: var(--danger-color); border-radius: 10px; font-family: var(--font-main); font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .delete-button:hover { background-color: var(--danger-color); color: #fff; }

        #wb-main-hub-page .content-group { margin-bottom: 30px; }
        #wb-main-hub-page .group-header { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px 5px; text-transform: uppercase; cursor: pointer; }
        #wb-main-hub-page .toggle-arrow { transition: transform 0.3s ease; }
        #wb-main-hub-page .card-container { display: grid; gap: 20px; max-height: 2000px; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        #wb-main-hub-page .content-group:not(.expanded) .card-container { max-height: 0; }
        #wb-main-hub-page .content-group.expanded .toggle-arrow { transform: rotate(180deg); }
        .hub-card, .entry-card {
            background-color: var(--card-bg);
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 4px 15px rgba(90, 110, 96, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 0;
        }
        .hub-card:hover, .entry-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(90, 110, 96, 0.12); }
        .hub-card .card-footer, .entry-card .card-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--placeholder-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75em;
            color: var(--text-light-fixed);
            gap: 10px;
        }
        .entry-card .card-footer span:first-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }
        .entry-card .card-footer .card-tag {
            flex-shrink: 0;
        }
        .card-tag { background-color: var(--placeholder-bg); color: var(--accent-color); padding: 3px 8px; border-radius: 8px; font-size: 0.7em; }
        .card-tag.disabled { background-color: #e0e0e0; color: #9e9e9e; }
        #wb-entry-list-content, #wb-prompt-list-content { display: grid; gap: 15px; align-content: start; }
        
        .advanced-settings summary { font-weight: bold; font-size: 0.9em; color: var(--text-color-fixed); cursor: pointer; padding: 10px 0; }
        .advanced-settings .settings-content { padding-top: 10px; }
        .form-row { display: flex; gap: 15px; } .form-row .form-group { flex: 1; }
        .settings-fieldset { border: 1px solid var(--placeholder-bg); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .settings-fieldset legend { font-weight: bold; font-size: 0.9em; padding: 0 10px; margin-left: 5px; color: var(--text-color-fixed); }
        
        .group-manage-item { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(90,110,96,0.06); }
        .group-manage-header { display: flex; justify-content: space-between; align-items: center; }
        .group-manage-header h3 { flex-grow: 1; margin: 0 10px 0 0; font-size: 1.05em; font-weight: bold; cursor: pointer; font-family: var(--font-main); }
        .group-manage-header .action-button-generic { flex-shrink: 0; }
        .group-manage-content-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px solid var(--placeholder-bg); cursor: pointer; transition: background-color 0.2s; }
        .group-manage-content-item:hover { background-color: var(--placeholder-bg); }
        .group-manage-content-item:last-child { border-bottom: none; }
        .group-manage-content-item span { font-size: 0.9em; pointer-events: none; }
        /* --- END: 角色书 & 世界书 CSS --- */
    </style>
</head>
<body>

    <div class="app-container">
        <!-- 全局状态栏 -->
        <header class="status-bar">
            <div class="status-bar-time" id="current-time"></div>
            <div class="status-bar-right-icons">
                <svg id="api-status-indicator" class="status-bar-svg-icon" width="13" height="13" viewBox="0 0 13 13" xmlns="http://www.w3.org/2000/svg"><circle cx="6.5" cy="6.5" r="4" fill="#cccccc"/></svg>
                <svg class="status-bar-svg-icon" width="20" height="13" viewBox="-1 -1 22 15" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M18.8186 0.749817H17.6519C17.0076 0.749817 16.4852 1.2535 16.4852 1.87482V11.6248C16.4852 12.2461 17.0076 12.7498 17.6519 12.7498H18.8186C19.4629 12.7498 19.9852 12.2461 19.9852 11.6248V1.87482C19.9852 1.2535 19.4629 0.749817 18.8186 0.749817ZM12.1617 3.37495H13.3284C13.9727 3.37495 14.495 3.87863 14.495 4.49995V11.625C14.495 12.2463 13.9727 12.75 13.3284 12.75H12.1617C11.5174 12.75 10.995 12.2463 10.995 11.625V4.49995C10.995 3.87863 11.5174 3.37495 12.1617 3.37495ZM7.83818 5.99974H6.67151C6.02718 5.99974 5.50484 6.50342 5.50484 7.12474V11.6247C5.50484 12.2461 6.02718 12.7497 6.67151 12.7497H7.83818C8.48251 12.7497 9.00484 12.2461 9.00484 11.6247V7.12474C9.00484 6.50342 8.48251 5.99974 7.83818 5.99974ZM2.34798 8.2497H1.18132C0.536983 8.2497 0.0146484 8.75338 0.0146484 9.3747V11.6247C0.0146484 12.246 0.536983 12.7497 1.18132 12.7497H2.34798C2.99231 12.7497 3.51465 12.246 3.51465 11.6247V9.3747C3.51465 8.75338 2.99231 8.2497 2.34798 8.2497Z"></path></svg>
                <svg class="status-bar-svg-icon" viewBox="0 0 18 13" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.00047 2.59599C11.467 2.5961 13.8393 3.56668 15.6269 5.30712C15.7615 5.44149 15.9766 5.43979 16.1092 5.30332L17.396 3.9734C17.4631 3.90418 17.5006 3.81042 17.5 3.71287C17.4994 3.61531 17.4609 3.52201 17.393 3.4536C12.7011 -1.1512 5.29908 -1.1512 0.607163 3.4536C0.539197 3.52196 0.500634 3.61523 0.500008 3.71279C0.499381 3.81034 0.536742 3.90413 0.603824 3.9734L1.89096 5.30332C2.02346 5.44 2.23878 5.4417 2.37331 5.30712C4.16116 3.56656 6.53367 2.59598 9.00047 2.59599ZM9.00045 6.92266C10.3557 6.92257 11.6625 7.43843 12.6671 8.36999C12.8029 8.5022 13.017 8.49933 13.1494 8.36353L14.4347 7.03361C14.5024 6.96386 14.5399 6.86922 14.539 6.77089C14.538 6.67255 14.4986 6.57872 14.4295 6.51039C11.3704 3.59629 6.63306 3.59629 3.57399 6.51039C3.50489 6.57872 3.46546 6.6726 3.46455 6.77097C3.46365 6.86933 3.50133 6.96396 3.56916 7.03361L4.85407 8.36353C4.98652 8.49933 5.20056 8.5022 5.33643 8.36999C6.34032 7.43905 7.64613 6.92323 9.00045 6.92266ZM11.5751 9.83398C11.5771 9.93259 11.5392 10.0277 11.4705 10.0968L9.24719 12.3945C9.18201 12.462 9.09316 12.5 9.00045 12.5C8.90773 12.5 8.81888 12.462 8.7537 12.3945L6.53006 10.0968C6.46137 10.0276 6.42358 9.93251 6.42562 9.8339C6.42765 9.73529 6.46933 9.64191 6.54082 9.57581C7.96068 8.34595 10.0402 8.34595 11.4601 9.57581C11.5315 9.64196 11.5731 9.73537 11.5751 9.83398Z"></path></svg>
                <div class="battery-container" id="battery-container">
                    <svg width="28" height="13" viewBox="0 0 28 13" xmlns="http://www.w3.org/2000/svg">
                        <rect class="battery-frame" opacity="0.4" x="1.17004" y="0.5" width="24" height="12" rx="3.5"></rect>
                        <path class="battery-terminal" opacity="0.5" d="M26.67 4.5V8.5C27.476 8.16122 28 7.37313 28 6.5C28 5.62687 27.476 4.83878 26.67 4.5Z"></path>
                        <rect class="battery-fill" id="battery-fill" x="2.17004" y="2" width="22" height="9" rx="2"></rect>
                        <g id="battery-charging-bolt"><path d="M512 393.216 229.376 512 430.08 512 471.04 630.784 753.664 512 552.96 512Z" class="battery-bolt-path" transform="translate(13.5, 6.5) scale(0.022) translate(-491.5, -512)"/></g>
                    </svg>
                </div>
            </div>
        </header>

        <!-- 桌面页面 -->
        <div id="desktop-page" class="page active">
            <main class="main-content">
                <div class="profile-card">
                    <div class="profile-banner" id="profile-banner"></div>
                    <div class="avatar-frame">
                        <div class="avatar" id="avatar-container"></div>
                        <div id="avatar-frame-overlay"></div>
                    </div>
                    <div class="profile-info">
                        <h1 class="nickname editable">点击编辑昵称</h1>
                        <p class="username editable">点击编辑ID</p>
                        <p class="bio editable">点击编辑签名</p>
                        <div class="location">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg>
                            <span class="editable">点击编辑地点</span>
                        </div>
                    </div>
                </div>
                <div class="middle-container">
                    <section class="main-layout">
                        <div class="widget-card-vertical" id="widget-left"></div>
                        <div class="app-grid-right">
                            <a href="#" class="app-icon"><div class="icon-placeholder" id="app-icon-1"></div><span>App 1</span></a>
                            <a href="#" class="app-icon"><div class="icon-placeholder" id="app-icon-2"></div><span>App 2</span></a>
                            <a href="#" class="app-icon"><div class="icon-placeholder" id="app-icon-3"></div><span>App 3</span></a>
                            <a href="#" class="app-icon"><div class="icon-placeholder" id="app-icon-4"></div><span>App 4</span></a>
                        </div>
                    </section>
                </div>
            </main>
            <footer class="dock">
                <a class="dock-icon" id="dock-icon-1-trigger"><div class="dock-icon-placeholder" id="dock-icon-1"></div></a>
                <a class="dock-icon" id="dock-icon-2-trigger"><div class="dock-icon-placeholder" id="dock-icon-2"></div></a>
                <a class="dock-icon" id="dock-icon-3-trigger"><div class="dock-icon-placeholder" id="dock-icon-3"></div></a>
                <a class="dock-icon" id="dock-icon-4-trigger"><div class="dock-icon-placeholder" id="dock-icon-4"></div></a>
            </footer>
        </div>
        <input type="file" id="banner-upload" accept="image/*" style="display: none;">
        <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
        <input type="file" id="widget-left-upload" accept="image/*" style="display: none;">

        <!-- 美化主页 -->
        <div id="beautify-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 class="app-title-generic">美化</h2>
            </header>
            <div class="app-content-area padded">
                <div class="setting-card" id="font-settings-card"><span>字体设置</span><span class="arrow">></span></div>
                <div class="setting-card" id="wallpaper-settings-card"><span>自定义壁纸</span><span class="arrow">></span></div>
                <div class="setting-card" id="theme-settings-card"><span>主题色设置</span><span class="arrow">></span></div>
                <div class="setting-card" id="avatar-frame-settings-card"><span>头像框设置</span><span class="arrow">></span></div>
                <div class="setting-card" id="icon-settings-card"><span>图标设置</span><span class="arrow">></span></div>
                <div class="setting-card" id="dock-settings-card"><span>底部栏</span><span class="arrow">></span></div>
            </div>
        </div>
        
        <!-- 美化子页面 -->
        <div id="font-settings-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 class="app-title-generic">字体设置</h2>
            </header>
            <div class="app-content-area padded">
                <div class="settings-section">
                    <h3>字体种类</h3>
                    <div class="control-group"><button class="btn" id="upload-font-btn">上传本地字体文件</button><input type="file" id="font-file-input" accept=".ttf,.otf,.woff,.woff2" style="display:none;"></div>
                    <div class="control-group"><label for="font-css-input">导入CSS代码</label><textarea id="font-css-input" class="textarea-field"></textarea></div>
                    <div class="control-group"><label for="font-url-input">输入字体文件URL</label><input type="text" id="font-url-input" class="input-field" placeholder="https://.../font.ttf"></div>
                </div>
                <div class="settings-section">
                    <h3 id="saved-fonts-toggle" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;"><span>已保存列表</span><span class="arrow">▼</span></h3>
                    <div id="saved-fonts-list-container" style="display: none; margin-top: 10px;"></div>
                </div>
                <div class="settings-section">
                    <h3>字体大小/粗细</h3>
                    <div class="control-group"><label>大小</label><div class="slider-container"><span>A</span><input type="range" id="font-size-slider" min="12" max="20" step="1" value="16"><span style="font-size: 1.25em;">A</span></div></div>
                    <div class="control-group"><label>粗细</label><div class="slider-container"><span>细</span><input type="range" id="font-weight-slider" min="100" max="900" step="100" value="400"><span style="font-weight: bold;">粗</span></div></div>
                </div>
                <div class="settings-section"><h3>实时预览</h3><div class="preview-box"><p id="font-preview">你好世界 Hello World</p><p id="font-details">京华老宋体 / 16px / 400</p></div></div>
                <div class="settings-section"><button class="btn btn-restore" id="restore-font-defaults">恢复默认</button></div>
            </div>
        </div>
        <div id="wallpaper-settings-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 class="app-title-generic">壁纸设置</h2>
            </header>
            <div class="app-content-area padded">
                <div class="settings-section">
                    <h3>图片来源</h3>
                    <div class="control-group"><button class="btn" id="upload-wallpaper-btn">上传本地图片</button><input type="file" id="wallpaper-file-input" accept="image/*" style="display:none;"></div>
                    <div class="control-group"><label for="wallpaper-url-input">输入图片URL</label><input type="text" id="wallpaper-url-input" class="input-field" placeholder="https://example.com/image.jpg"></div>
                </div>
                <div class="settings-section"><label><input type="checkbox" id="enable-wallpaper-preview"> 启用实时预览</label><div id="wallpaper-preview-section" style="display:none;"><div id="wallpaper-preview"></div></div></div>
                <div class="settings-section"><button class="btn btn-restore" id="restore-wallpaper-defaults">恢复默认</button></div>
            </div>
        </div>
        <div id="icon-settings-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 class="app-title-generic">图标设置</h2>
            </header>
            <div class="app-content-area padded">
                <div class="settings-section"><div id="app-icon-controls"></div></div>
                <div class="settings-section"><button class="btn btn-restore" id="restore-icon-defaults">恢复默认</button></div>
            </div>
        </div>
        <div id="theme-settings-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 class="app-title-generic">主题色设置</h2>
            </header>
            <div class="app-content-area padded">
                <div class="settings-section"><h3>实时预览</h3><div id="theme-color-preview"></div></div>
                <div class="settings-section"><h3>输入色号 (HEX)</h3><div class="control-group"><input type="text" id="theme-color-hex" class="input-field" value="#e8f0e9"></div></div>
                <div class="settings-section"><button class="btn btn-restore" id="restore-theme-defaults">恢复默认</button></div>
            </div>
        </div>
        <div id="dock-settings-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 class="app-title-generic">底部栏设置</h2>
            </header>
            <div class="app-content-area padded">
                <div class="settings-section"><h3>选项</h3><label><input type="checkbox" id="dock-white-bg-toggle"> 使用纯白/透明底部栏 (不跟随主题色)</label></div>
                <div class="settings-section"><h3>透明度</h3><div class="control-group"><div class="slider-container"><span style="font-size: 0.8em;">透明</span><input type="range" id="dock-opacity-slider" min="0" max="1" step="0.05" value="0.85"><span style="font-size: 0.8em;">不透明</span></div></div></div>
                <div class="settings-section"><h3>实时预览</h3><div id="dock-preview" style="height: 60px; border-radius: 20px; transition: background-color 0.3s; display: flex; align-items: center; justify-content: space-around; padding: 0 20px; border: 1px solid var(--border-color);"><div style="width: 40px; height: 40px; background-color: rgba(255,255,255,0.5); border-radius: 10px;"></div><div style="width: 40px; height: 40px; background-color: rgba(255,255,255,0.5); border-radius: 10px;"></div><div style="width: 40px; height: 40px; background-color: rgba(255,255,255,0.5); border-radius: 10px;"></div><div style="width: 40px; height: 40px; background-color: rgba(255,255,255,0.5); border-radius: 10px;"></div></div></div>
                <div class="settings-section"><button class="btn btn-restore" id="restore-dock-defaults">恢复默认</button></div>
            </div>
        </div>
        <div id="avatar-frame-settings-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 class="app-title-generic">头像框设置</h2>
            </header>
            <div class="app-content-area padded">
                <div class="settings-section"><h3>选项</h3><label><input type="checkbox" id="enable-avatar-frame-toggle"> 启用头像框</label></div>
                <div class="settings-section"><h3>自定义头像框</h3><div class="control-group"><button class="btn" id="upload-avatar-frame-btn">上传本地图片 (PNG/GIF)</button><input type="file" id="avatar-frame-file-input" accept="image/png,image/gif" style="display:none;"></div><div class="control-group"><label for="avatar-frame-url-input">或输入图片URL</label><input type="text" id="avatar-frame-url-input" class="input-field" placeholder="https://.../frame.gif"></div></div>
                <div class="settings-section">
                    <h3>位置与大小微调</h3>
                    <div class="control-group"><label for="avatar-frame-x-slider">水平位置 (X)</label><div class="slider-container"><span>-</span><input type="range" id="avatar-frame-x-slider" min="-20" max="20" value="0" step="1"><span>+</span></div></div>
                    <div class="control-group"><label for="avatar-frame-y-slider">垂直位置 (Y)</label><div class="slider-container"><span>-</span><input type="range" id="avatar-frame-y-slider" min="-20" max="20" value="0" step="1"><span>+</span></div></div>
                    <div class="control-group"><label for="avatar-frame-scale-slider">缩放大小</label><div class="slider-container"><span>小</span><input type="range" id="avatar-frame-scale-slider" min="0.8" max="1.5" value="1" step="0.01"><span>大</span></div></div>
                </div>
                <div class="settings-section"><h3>实时预览</h3><div class="avatar-frame-preview"><div id="preview-avatar" class="avatar"></div><div id="preview-avatar-frame"></div></div></div>
                <div class="settings-section"><button class="btn btn-restore" id="restore-avatar-frame-defaults">恢复默认</button></div>
            </div>
        </div>

        <!-- API 配置页面 -->
        <div id="api-config-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 class="app-title-generic" id="api-page-title">API 配置</h2>
            </header>
            <div class="page-container">
                <div id="api-config-view" class="page-view active">
                    <div class="settings-section">
                        <div class="control-group"><label for="api-provider-select">服务商</label><select id="api-provider-select" class="select-field"><option value="openai">OpenAI</option><option value="gemini">Gemini</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="reverse_proxy">反向代理</option><option value="custom">自定义 (OpenAI 格式)</option><option value="polling">轮询</option></select></div>
                        <div class="control-group"><label for="api-url-input">API URL</label><input type="text" id="api-url-input" class="input-field"></div>
                        <div class="control-group"><label for="api-key-input">API Key</label><div class="input-with-button"><input type="password" id="api-key-input" class="input-field"><textarea id="api-key-textarea" class="textarea-field" style="display: none;" placeholder="每行输入一个 Key"></textarea><button id="toggle-api-key-visibility" class="btn-icon"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg></button></div></div>
                        <div class="control-group"><label for="api-model-select">模型</label><select id="api-model-select" class="select-field"></select></div>
                    </div>
                    <div class="settings-section"><button class="btn" id="test-connection-btn">连接测试 & 拉取模型</button><p id="connection-status"></p></div>
                    <div class="settings-section"><button class="btn" id="save-api-settings-btn" style="background-color: var(--accent-color); color: white;">保存设置</button><button class="btn btn-restore" id="restore-api-defaults-btn">恢复默认</button></div>
                </div>
                <div id="api-presets-view" class="page-view"><div id="presets-list-container"></div></div>
            </div>
            <footer id="api-config-page-footer" class="app-footer"><button id="nav-config-btn" class="nav-btn active">配置</button><button id="nav-presets-btn" class="nav-btn">预设</button></footer>
        </div>
        
        <!-- 角色书/用户人设 页面 -->
        <div id="char-list-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 id="char-book-title" class="app-title-generic clickable">角色书 (Char)</h2>
                <div class="header-actions-generic">
                    <div style="position: relative;">
                        <button id="char-add-button" class="action-button-generic" aria-label="新建"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                        <div id="char-add-menu" class="dropdown-menu-generic right-aligned">
                            <a href="#" id="char-add-new-item-btn" class="dropdown-item-generic">新建角色书</a>
                            <a href="#" id="char-import-json-btn" class="dropdown-item-generic">导入JSON角色卡</a>
                            <div class="dropdown-divider-generic"></div>
                            <a href="#" id="char-manage-groups-btn" class="dropdown-item-generic">分组管理</a>
                        </div>
                    </div>
                </div>
            </header>
            <main id="char-list-content-area" class="app-content-area"></main>
        </div>

        <!-- 角色书编辑器 -->
        <div id="char-editor-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 id="char-editor-title" class="app-title-generic">新建角色</h2>
                <button id="save-char-button" class="header-btn-generic right-header-btn-generic">保存</button>
            </header>
            <main class="editor-content">
                <div class="avatar-uploader">
                    <div id="char-avatar-preview" class="avatar-preview" data-image-data=""></div>
                </div>
                <input type="file" id="char-avatar-file-input" accept="image/*" style="display: none;">
                <div class="form-group"><label for="char-avatar-url">或输入头像URL</label><input type="text" id="char-avatar-url" placeholder="https://..."></div>
                <div class="form-group"><label for="char-name">名字</label><input type="text" id="char-name" placeholder="为你的角色起个名字"></div>
                <div class="form-group"><label for="char-group">所属分组</label><select id="char-group"></select></div>
                <div class="form-group"><label for="char-worldbook-select">绑定世界书</label><select id="char-worldbook-select"></select></div>
                <div class="form-group"><label for="char-bio">一句话简介</label><input type="text" id="char-bio" placeholder="对角色的简短概括"></div>
                <div class="form-group"><label for="char-desc">角色描述</label><textarea id="char-desc" placeholder="详细描述角色的性格、背景、外貌等..."></textarea></div>
                <div class="form-group">
                    <label>开场白</label>
                    <div class="setting-item"><div class="setting-item-label"><span>线上开场白</span><button id="add-online-greeting" class="add-greeting-btn">+ 新建</button></div><label class="switch-container"><input type="checkbox" id="online-opening-switch"><span class="switch-slider"></span></label></div>
                    <div class="opening-text-container" id="online-opening-container"></div>
                    <div class="setting-item"><div class="setting-item-label"><span>线下开场白</span><button id="add-offline-greeting" class="add-greeting-btn">+ 新建</button></div><label class="switch-container"><input type="checkbox" id="offline-opening-switch"><span class="switch-slider"></span></label></div>
                    <div class="opening-text-container" id="offline-opening-container"></div>
                </div>
                <div id="delete-button-container" class="delete-button-container"><button id="delete-char-button" class="delete-button">删除角色</button></div>
            </main>
        </div>

        <!-- 用户人设编辑器 (NEW) -->
        <div id="user-persona-editor-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 id="user-persona-editor-title" class="app-title-generic">新建用户人设</h2>
                <button id="save-user-persona-button" class="header-btn-generic right-header-btn-generic">保存</button>
            </header>
            <main class="editor-content">
                <div class="avatar-uploader">
                    <div id="user-persona-avatar-preview" class="avatar-preview" data-image-data=""></div>
                </div>
                <input type="file" id="user-persona-avatar-file-input" accept="image/*" style="display: none;">
                <div class="form-group"><label for="user-persona-avatar-url">或输入头像URL</label><input type="text" id="user-persona-avatar-url" placeholder="https://..."></div>
                <div class="form-group"><label for="user-persona-name">名字</label><input type="text" id="user-persona-name" placeholder="为你的人设起个名字"></div>
                <div class="form-group"><label for="user-persona-group">所属分组</label><select id="user-persona-group"></select></div>
                <div class="form-group"><label for="user-persona-bio">一句话简介</label><input type="text" id="user-persona-bio" placeholder="对人设的简短概括"></div>
                <div class="form-group"><label for="user-persona-desc">角色描述</label><textarea id="user-persona-desc" placeholder="详细描述人设的性格、背景、外貌等..."></textarea></div>
                <div class="form-group"><label for="user-persona-memory">重点记忆</label><textarea id="user-persona-memory" placeholder="需要重点记忆的内容..."></textarea></div>
                <div id="delete-user-persona-container" class="delete-button-container"><button id="delete-user-persona-button" class="delete-button">删除人设</button></div>
            </main>
        </div>

        <div id="char-group-manager-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 id="group-manager-title" class="app-title-generic">分组管理</h2>
                <div class="header-actions-generic"><button id="add-new-group-btn" class="action-button-generic" aria-label="新建分组"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button></div>
            </header>
            <main id="group-manager-content" class="app-content-area padded"></main>
        </div>
        <input type="file" id="char-json-char-input" accept=".json" style="display: none;">
        
        <!-- 世界书页面 -->
        <div id="wb-main-hub-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 class="app-title-generic">内容中心</h2>
                <div class="header-actions-generic">
                    <div style="position: relative;">
                        <button id="wb-add-button" class="action-button-generic" aria-label="新建"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                        <div id="wb-add-menu" class="dropdown-menu-generic right-aligned">
                            <a id="wb-upload-json-btn" href="#" class="dropdown-item-generic">上传JSON文件</a><div class="dropdown-divider-generic"></div>
                            <a id="wb-custom-book-btn" href="#" class="dropdown-item-generic">新建世界书</a><a id="wb-custom-preset-btn" href="#" class="dropdown-item-generic">新建预设</a><div class="dropdown-divider-generic"></div>
                            <a id="wb-manage-groups-btn" href="#" class="dropdown-item-generic">管理分组</a>
                        </div>
                    </div>
                </div>
            </header>
            <main id="wb-main-content-area" class="app-content-area padded"></main>
        </div>
        <div id="wb-book-editor-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 id="wb-book-editor-title" class="app-title-generic">编辑世界书</h2>
                <button id="wb-save-book-button" class="header-btn-generic right-header-btn-generic">保存</button>
            </header>
            <main class="editor-content">
                <div class="form-group"><label for="wb-book-name">名称</label><input type="text" id="wb-book-name"></div>
                <div class="form-group"><label for="wb-book-group">分组</label><select id="wb-book-group"></select></div>
                <div class="form-group"><label for="wb-book-description">简介</label><textarea id="wb-book-description"></textarea></div>
                <div id="wb-delete-book-container" class="delete-button-container" style="display: none;">
                    <button id="wb-delete-book-button" class="delete-button">删除世界书</button>
                </div>
            </main>
        </div>
        <div id="wb-entry-list-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 id="wb-entry-list-title" class="app-title-generic clickable">条目</h2>
                <div class="header-actions-generic"><button id="wb-new-entry-button" class="action-button-generic" aria-label="新建条目"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button></div>
             </header>
            <main id="wb-entry-list-content" class="app-content-area padded"></main>
        </div>
        <div id="wb-entry-editor-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 id="wb-entry-editor-title" class="app-title-generic">编辑</h2>
                <button id="wb-save-entry-button" class="header-btn-generic right-header-btn-generic">保存</button>
            </header>
            <main class="editor-content">
                <div class="form-group"><label id="wb-comment-label" for="wb-comment">注释</label><input type="text" id="wb-comment"></div>
                <div class="form-group"><label for="wb-content">内容</label><textarea id="wb-content"></textarea></div>
                <fieldset class="settings-fieldset"><legend>触发规则</legend>
                    <div class="setting-item"><span>启用</span><label class="switch-container"><input type="checkbox" id="wb-enabled"><span class="switch-slider"></span></label></div>
                    <div class="setting-item"><span>常时</span><label class="switch-container"><input type="checkbox" id="wb-constant"><span class="switch-slider"></span></label></div>
                    <div class="setting-item"><span>选择性</span><label class="switch-container"><input type="checkbox" id="wb-selective"><span class="switch-slider"></span></label></div>
                </fieldset>
                <div class="worldbook-only">
                    <details class="advanced-settings"><summary>高级设置 (世界书专用)</summary>
                        <div class="settings-content">
                            <div class="form-group"><label for="wb-keys">关键词</label><input type="text" id="wb-keys" placeholder="用英文逗号 , 分隔"></div>
                            <fieldset class="settings-fieldset"><legend>注入规则</legend>
                                <div class="form-group"><label for="wb-position">注入位置</label><select id="wb-position"><optgroup label="常规注入"><option value="0">角色定义前</option><option value="1">角色定义后</option><option value="2">示例消息前</option><option value="3">示例消息后</option></optgroup><optgroup label="作者注释 (世界书)"><option value="4" selected>作者注释</option><option value="5">作者注释-前置</option></optgroup><optgroup label="动态注入 (Dynamic)"><option value="6">D-系统</option><option value="7">D-用户</option><option value="8">D-AI</option></optgroup></select></div>
                                <div class="form-row"><div class="form-group"><label for="wb-order">顺序</label><input type="number" id="wb-order" value="100"></div><div class="form-group"><label for="wb-depth">深度</label><input type="number" id="wb-depth" value="4" min="0"></div></div>
                            </fieldset>
                            <fieldset class="settings-fieldset"><legend>其他触发规则</legend>
                                <div class="setting-item"><span>防止递归</span><label class="switch-container"><input type="checkbox" id="wb-prevent-recursion"><span class="switch-slider"></span></label></div>
                                <div class="setting-item"><span>启用概率</span><label class="switch-container"><input type="checkbox" id="wb-use-probability"><span class="switch-slider"></span></label></div>
                                <div class="form-group" style="margin-top: 15px;"><label for="wb-probability">触发概率</label><input type="number" id="wb-probability" value="100" min="0" max="100"></div>
                            </fieldset>
                        </div>
                    </details>
                </div>
            </main>
        </div>
        <div id="wb-preset-editor-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 id="wb-preset-editor-title" class="app-title-generic">编辑预设</h2>
                <button id="wb-save-preset-button" class="header-btn-generic right-header-btn-generic">保存</button>
            </header>
            <main class="editor-content">
                <div class="form-group"><label for="wb-preset-name">名称</label><input type="text" id="wb-preset-name"></div>
                <div class="form-group"><label for="wb-preset-group">分组</label><select id="wb-preset-group"></select></div>
                <div class="form-group"><label for="wb-preset-description">简介</label><textarea id="wb-preset-description"></textarea></div>
                <details class="advanced-settings" open><summary>模型参数</summary>
                    <div class="settings-content">
                        <div class="form-group slider-group"><label for="wb-preset-temperature">Temperature <span id="wb-preset-temperature-value">1.0</span></label><input type="range" id="wb-preset-temperature" min="0" max="2" step="0.1" value="1.0"></div>
                        <div class="form-group slider-group"><label for="wb-preset-max-context">上下文长度 <span id="wb-preset-max-context-value">4096</span></label><input type="range" id="wb-preset-max-context" min="1024" max="150000" step="1024" value="4096"></div>
                        <div class="form-group slider-group"><label for="wb-preset-top-p">Top P <span id="wb-preset-top-p-value">1.0</span></label><input type="range" id="wb-preset-top-p" min="0" max="1" step="0.05" value="1.0"></div>
                        <div class="form-group slider-group"><label for="wb-preset-top-k">Top K <span id="wb-preset-top-k-value">0</span></label><input type="range" id="wb-preset-top-k" min="0" max="500" step="1" value="0"></div>
                        <div class="form-group slider-group"><label for="wb-preset-freq-penalty">Frequency Penalty <span id="wb-preset-freq-penalty-value">0.0</span></label><input type="range" id="wb-preset-freq-penalty" min="0" max="2" step="0.1" value="0.0"></div>
                        <div class="form-group slider-group"><label for="wb-preset-presence-penalty">Presence Penalty <span id="wb-preset-presence-penalty-value">0.0</span></label><input type="range" id="wb-preset-presence-penalty" min="0" max="2" step="0.1" value="0.0"></div>
                    </div>
                </details>
                <div id="wb-delete-preset-container" class="delete-button-container" style="display: none;">
                    <button id="wb-delete-preset-button" class="delete-button">删除预设</button>
                </div>
            </main>
        </div>
        <div id="wb-prompt-list-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 id="wb-prompt-list-title" class="app-title-generic clickable">提示词</h2>
                <div class="header-actions-generic"><button id="wb-new-prompt-button" class="action-button-generic" aria-label="新建提示词"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button></div>
             </header>
            <main id="wb-prompt-list-content" class="app-content-area padded"></main>
        </div>
        <div id="wb-group-manager-page" class="page">
            <header class="app-header-generic">
                <button class="header-btn-generic back-button-generic" aria-label="返回"><svg viewBox="0 0 24 24" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <h2 class="app-title-generic">分组管理</h2>
                <div class="header-actions-generic"><button id="wb-add-new-group-btn" class="action-button-generic" aria-label="新建分组"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button></div>
            </header>
            <main id="wb-group-manager-content" class="app-content-area padded"></main>
        </div>
        <input type="file" id="wb-json-file-input" accept=".json" style="display: none;">
    </div>

    <!-- 全局模态对话框 -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <h3 id="modal-title">编辑信息</h3>
            <textarea id="modal-input" class="modal-input" rows="3"></textarea>
            <div class="modal-actions">
                <button class="modal-button cancel" id="modal-cancel">取消</button>
                <button class="modal-button save" id="modal-save">保存</button>
            </div>
        </div>
    </div>
    <div id="prompt-overlay" class="custom-prompt-overlay">
        <div class="custom-prompt-box">
            <h3 id="prompt-title"></h3>
            <div id="prompt-content"></div>
            <div class="custom-prompt-buttons">
                <button id="prompt-cancel" class="btn">取消</button>
                <button id="prompt-confirm" class="btn btn-primary">确认</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. 全局状态与数据中心 ---
    let globalState = {
        history: ['desktop-page'],
        characterBookView: 'char', // NEW: 'char' or 'user'
        currentGroupManagementContext: 'char', // NEW: 'char' or 'user'

        characters: [],
        characterGroups: ['默认分组'],
        characterCollapsedGroups: [],
        editingCharId: null,

        userPersonas: [], // NEW
        userPersonaGroups: ['默认分组'], // NEW
        editingUserPersonaId: null, // NEW

        worldBooks: [],
        presets: [], 
        contentGroups: ["未分组"],
        contentExpandedGroups: ["未分组"],
        currentBookId: null,
        currentPresetId: null,
        currentEntryUid: null,
        currentWbContext: null,
        pendingPresetData: null,
    };

    // --- 2. DOM元素缓存 ---
    const appContainer = document.querySelector('.app-container');
    appContainer.style.height = `${window.innerHeight}px`;
    const globalModals = {
        editModal: { overlay: document.getElementById('edit-modal'), title: document.getElementById('modal-title'), input: document.getElementById('modal-input'), save: document.getElementById('modal-save'), cancel: document.getElementById('modal-cancel'), onSaveCallback: null },
        prompt: { overlay: document.getElementById('prompt-overlay'), title: document.getElementById('prompt-title'), content: document.getElementById('prompt-content'), confirmBtn: document.getElementById('prompt-confirm'), cancelBtn: document.getElementById('prompt-cancel'), resolve: null }
    };

    // --- 3. 核心功能函数 (导航, 弹窗等) ---
    function showPage(pageId, isBack = false) {
        const currentPageId = globalState.history[globalState.history.length - 1];
        if (currentPageId === pageId && !isBack) return;
        const currentPage = document.getElementById(currentPageId);
        const nextPage = document.getElementById(pageId);
        if (!nextPage) { console.error(`Page not found: ${pageId}`); return; }
        if (currentPage && currentPage !== nextPage) { currentPage.classList.remove('active'); currentPage.classList.add('exit-to-background'); }
        nextPage.classList.add('active');
        setTimeout(() => { if(currentPage && currentPage !== nextPage) currentPage.classList.remove('exit-to-background'); }, 400);
        if (!isBack) { globalState.history.push(pageId); } else if (globalState.history.length > 1) { globalState.history.pop(); }
    }

    function goBack() { if (globalState.history.length <= 1) return; const prevPageId = globalState.history[globalState.history.length - 2]; showPage(prevPageId, true); }
    function openEditModal(title, value, onSave, isSingleLine = false) { const modal = globalModals.editModal; modal.onSaveCallback = onSave; modal.title.textContent = title; modal.input.value = value; modal.input.style.resize = isSingleLine ? 'none' : 'vertical'; modal.input.rows = isSingleLine ? 1 : 3; modal.overlay.classList.add('visible'); modal.input.focus(); }
    function closeEditModal() { const modal = globalModals.editModal; modal.overlay.classList.remove('visible'); modal.onSaveCallback = null; }
    function showPrompt({title, html, confirmText = '确认', confirmClass = 'btn-primary'}) { const prompt = globalModals.prompt; prompt.title.textContent = title; prompt.content.innerHTML = html; prompt.confirmBtn.textContent = confirmText; prompt.confirmBtn.className = `btn ${confirmClass}`; prompt.overlay.classList.add('visible'); return new Promise(resolve => { prompt.resolve = resolve; }); }
    function hidePrompt() { const prompt = globalModals.prompt; prompt.overlay.classList.remove('visible'); if (prompt.resolve) { prompt.resolve(null); prompt.resolve = null; } }

    // --- 4. 桌面 & 美化APP逻辑 ---
    const desktopLogic = (() => {
        const controls = {
            font: { cssInput: document.getElementById('font-css-input'), urlInput: document.getElementById('font-url-input'), fileInput: document.getElementById('font-file-input'), sizeSlider: document.getElementById('font-size-slider'), weightSlider: document.getElementById('font-weight-slider'), previewDetails: document.getElementById('font-details'), dynamicStyle: document.getElementById('dynamic-font-style'), fontLinkContainer: document.getElementById('font-link-container'), restoreBtn: document.getElementById('restore-font-defaults') },
            wallpaper: { previewEnabledCheckbox: document.getElementById('enable-wallpaper-preview'), previewSection: document.getElementById('wallpaper-preview-section'), previewElement: document.getElementById('wallpaper-preview'), urlInput: document.getElementById('wallpaper-url-input'), restoreBtn: document.getElementById('restore-wallpaper-defaults') },
            icon: { container: document.getElementById('app-icon-controls'), restoreBtn: document.getElementById('restore-icon-defaults') },
            theme: { preview: document.getElementById('theme-color-preview'), hexInput: document.getElementById('theme-color-hex'), restoreBtn: document.getElementById('restore-theme-defaults') },
            dock: { whiteBgToggle: document.getElementById('dock-white-bg-toggle'), opacitySlider: document.getElementById('dock-opacity-slider'), previewBox: document.getElementById('dock-preview'), restoreBtn: document.getElementById('restore-dock-defaults') },
            avatarFrame: { toggle: document.getElementById('enable-avatar-frame-toggle'), uploadBtn: document.getElementById('upload-avatar-frame-btn'), fileInput: document.getElementById('avatar-frame-file-input'), urlInput: document.getElementById('avatar-frame-url-input'), restoreBtn: document.getElementById('restore-avatar-frame-defaults'), mainFrame: document.getElementById('avatar-frame-overlay'), previewFrame: document.getElementById('preview-avatar-frame'), mainAvatar: document.getElementById('avatar-container'), previewAvatar: document.getElementById('preview-avatar'), xSlider: document.getElementById('avatar-frame-x-slider'), ySlider: document.getElementById('avatar-frame-y-slider'), scaleSlider: document.getElementById('avatar-frame-scale-slider') },
            savedFonts: { toggle: document.getElementById('saved-fonts-toggle'), listContainer: document.getElementById('saved-fonts-list-container') }
        };
        let currentFontName = 'KingHwaOldSong';
        const defaultCssContent = `<link rel="preload" as="style" crossorigin href="https://fontsapi.zeoseven.com/309/main/result.css" onload="this.rel='stylesheet'" onerror="this.href='httpsapi-storage.zeoseven.com/309/main/result.css'" /><noscript><link rel="stylesheet" href="https://fontsapi.zeoseven.com/309/main/result.css" /></noscript>`;
        let currentAvatarFrameURL = null; let db;

        function openDb() { return new Promise((resolve, reject) => { const request = indexedDB.open('FontStorageDB', 1); request.onupgradeneeded = event => { db = event.target.result; if (!db.objectStoreNames.contains('fonts')) { db.createObjectStore('fonts', { keyPath: 'id', autoIncrement: true }); } }; request.onsuccess = event => { db = event.target.result; resolve(db); }; request.onerror = event => reject('Database error: ' + event.target.errorCode); }); }
        const addFontToDb = (font) => new Promise((resolve, reject) => { const transaction = db.transaction(['fonts'], 'readwrite'); const store = transaction.objectStore('fonts'); const request = store.add(font); request.onsuccess = resolve; request.onerror = reject; });
        const getAllFontsFromDb = () => new Promise((resolve, reject) => { const transaction = db.transaction(['fonts'], 'readonly'); const store = transaction.objectStore('fonts'); const request = store.getAll(); request.onsuccess = () => resolve(request.result); request.onerror = reject; });
        const deleteFontFromDb = (id) => new Promise((resolve, reject) => { const transaction = db.transaction(['fonts'], 'readwrite'); const store = transaction.objectStore('fonts'); const request = store.delete(id); request.onsuccess = resolve; request.onerror = reject; });

        function updateGlobalStyle(property, value) { document.documentElement.style.setProperty(property, value); if (property.startsWith('--font') || property.startsWith('--global-font')) { updateFontPreview(); } }
        function updateFontPreview() { const size = controls.font.sizeSlider.value + 'px'; const weight = controls.font.weightSlider.value; controls.font.previewDetails.textContent = `${currentFontName} / ${size} / ${weight}`; }
        async function renderSavedFontsList() { const fonts = await getAllFontsFromDb(); controls.savedFonts.listContainer.innerHTML = ''; if (fonts.length === 0) { controls.savedFonts.listContainer.innerHTML = '<p style="text-align: center; color: var(--text-light-fixed); font-size: 0.8em;">暂无已保存字体</p>'; return; } fonts.forEach(font => { const item = document.createElement('div'); item.className = 'saved-font-item'; item.dataset.fontId = font.id; item.innerHTML = `<span class="saved-font-name" title="${font.name}">${font.name}</span><button class="delete-font-btn" data-font-id="${font.id}">×</button>`; controls.savedFonts.listContainer.appendChild(item); }); }
        function applySavedFont(font) { let fontUrl; if (font.type === 'data' && font.value instanceof Blob) { fontUrl = URL.createObjectURL(font.value); } else { fontUrl = font.value; } const cssFontName = `SavedFont_${font.name.replace(/[^a-zA-Z0-9]/g, '')}_${Date.now()}`; controls.font.dynamicStyle.innerHTML = `@font-face { font-family: '${cssFontName}'; src: url('${fontUrl}'); }`; currentFontName = font.name; updateGlobalStyle('--font-main', `'${cssFontName}', sans-serif`); }
        
        function applyThemeColor(color) { 
            updateGlobalStyle('--placeholder-bg', color); 
            const lighterBg = `color-mix(in srgb, ${color} 60%, #ffffff)`;
            updateGlobalStyle('--screen-bg-themed', lighterBg);
            if (!appContainer.style.backgroundImage || appContainer.style.backgroundImage === 'none') {
                updateGlobalStyle('--screen-bg', lighterBg);
                appContainer.style.backgroundColor = lighterBg;
            }
            let r = parseInt(color.slice(1, 3), 16), g = parseInt(color.slice(3, 5), 16), b = parseInt(color.slice(5, 7), 16); 
            const accent = `rgb(${Math.max(0,r-80)}, ${Math.max(0,g-80)}, ${Math.max(0,b-80)})`; 
            updateGlobalStyle('--accent-color', accent); 
            controls.theme.preview.style.backgroundColor = color; 
            updateDockAppearance();
        }

        function applyWallpaper(imageUrl) {
            const urlString = imageUrl ? `url('${imageUrl}')` : 'none';
            appContainer.style.backgroundImage = urlString;
            appContainer.classList.toggle('has-wallpaper', !!imageUrl);
            if (imageUrl) {
                appContainer.style.backgroundColor = 'transparent';
            } else {
                const themedBg = getComputedStyle(document.documentElement).getPropertyValue('--screen-bg-themed').trim();
                appContainer.style.backgroundColor = themedBg;
                updateGlobalStyle('--screen-bg', themedBg);
            }
            if (controls.wallpaper.previewEnabledCheckbox.checked) {
                controls.wallpaper.previewElement.style.backgroundImage = urlString;
                controls.wallpaper.previewElement.style.backgroundColor = imageUrl ? 'transparent' : 'var(--placeholder-bg)';
            }
        }

        function hexToRgba(hex, alpha = 1) { let r = 0, g = 0, b = 0; if (hex.length == 4) { r = parseInt(hex[1] + hex[1], 16); g = parseInt(hex[2] + hex[2], 16); b = parseInt(hex[3] + hex[3], 16); } else if (hex.length == 7) { r = parseInt(hex.slice(1, 3), 16); g = parseInt(hex.slice(3, 5), 16); b = parseInt(hex.slice(5, 7), 16); } return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
        
        function updateDockAppearance() { const opacity = controls.dock.opacitySlider.value; const isWhite = controls.dock.whiteBgToggle.checked; const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--placeholder-bg').trim(); const baseHex = isWhite ? '#ffffff' : themeColor; const newDockColor = hexToRgba(baseHex, opacity); updateGlobalStyle('--dock-bg', newDockColor); controls.dock.previewBox.style.backgroundColor = newDockColor; }
        function applyAvatarFrame() { const isEnabled = controls.avatarFrame.toggle.checked; const imageUrl = controls.avatarFrame.urlInput.value.trim(); const frameElements = [controls.avatarFrame.mainFrame, controls.avatarFrame.previewFrame]; const avatarElements = [controls.avatarFrame.mainAvatar, controls.avatarFrame.previewAvatar]; avatarElements.forEach(el => el.classList.toggle('avatar-framed', isEnabled)); frameElements.forEach(el => { el.style.backgroundImage = 'none'; el.style.boxShadow = 'none'; if (isEnabled) { if (imageUrl) { el.style.backgroundImage = `url('${imageUrl}')`; } else { el.style.boxShadow = '0 0 0 3px var(--card-bg), 0 4px 10px rgba(0,0,0,0.15)'; } } }); }
        function applyAvatarFrameTransform() { const x = controls.avatarFrame.xSlider.value; const y = controls.avatarFrame.ySlider.value; const scale = controls.avatarFrame.scaleSlider.value; const transformValue = `translate(${x}px, ${y}px) scale(${scale})`; [controls.avatarFrame.mainFrame, controls.avatarFrame.previewFrame].forEach(el => { el.style.transform = transformValue; }); }
        function setupImageUpload(triggerId, inputId, callback) { document.getElementById(triggerId).addEventListener('click', () => document.getElementById(inputId).click()); document.getElementById(inputId).addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const objectURL = URL.createObjectURL(file); callback(objectURL); } }); }
        
        async function init() {
            await openDb(); await renderSavedFontsList();
            document.getElementById('dock-icon-1-trigger').addEventListener('click', () => showPage('beautify-page'));
            document.getElementById('font-settings-card').addEventListener('click', () => showPage('font-settings-page'));
            document.getElementById('wallpaper-settings-card').addEventListener('click', () => showPage('wallpaper-settings-page'));
            document.getElementById('icon-settings-card').addEventListener('click', () => showPage('icon-settings-page'));
            document.getElementById('theme-settings-card').addEventListener('click', () => showPage('theme-settings-page'));
            document.getElementById('dock-settings-card').addEventListener('click', () => showPage('dock-settings-page'));
            document.getElementById('avatar-frame-settings-card').addEventListener('click', () => showPage('avatar-frame-settings-page'));
            document.querySelector('.nickname').addEventListener('click', (e) => openEditModal('编辑昵称', e.target.textContent, (val) => e.target.textContent = val, true));
            document.querySelector('.username').addEventListener('click', (e) => openEditModal('编辑ID', e.target.textContent, (val) => e.target.textContent = val, true));
            document.querySelector('.bio').addEventListener('click', (e) => openEditModal('编辑签名', e.target.textContent, (val) => e.target.textContent = val));
            document.querySelector('.location span').addEventListener('click', (e) => openEditModal('编辑地点', e.target.textContent, (val) => e.target.textContent = val, true));
            controls.font.cssInput.value = defaultCssContent; controls.font.cssInput.addEventListener('input', () => { controls.font.fontLinkContainer.innerHTML = controls.font.cssInput.value; const match = controls.font.cssInput.value.match(/font-family:\s*["']?([^;"']+)["']?/); if (match && match[1]) { currentFontName = match[1]; updateGlobalStyle('--font-main', match[1]); } });
            controls.font.sizeSlider.addEventListener('input', () => updateGlobalStyle('--global-font-size', controls.font.sizeSlider.value + 'px'));
            controls.font.weightSlider.addEventListener('input', () => updateGlobalStyle('--global-font-weight', controls.font.weightSlider.value));
            controls.font.restoreBtn.addEventListener('click', () => { currentFontName = 'KingHwaOldSong'; controls.font.cssInput.value = defaultCssContent; controls.font.urlInput.value = ''; controls.font.fontLinkContainer.innerHTML = defaultCssContent; controls.font.dynamicStyle.innerHTML = ''; controls.font.sizeSlider.value = 16; controls.font.weightSlider.value = 400; updateGlobalStyle('--font-main', '"KingHwaOldSong", sans-serif'); updateGlobalStyle('--global-font-size', '16px'); updateGlobalStyle('--global-font-weight', '400'); });
            controls.savedFonts.toggle.addEventListener('click', () => { const isExpanded = controls.savedFonts.listContainer.style.display === 'block'; controls.savedFonts.listContainer.style.display = isExpanded ? 'none' : 'block'; controls.savedFonts.toggle.classList.toggle('expanded', !isExpanded); });
            controls.savedFonts.listContainer.addEventListener('click', async (e) => { const target = e.target; if (target.classList.contains('delete-font-btn')) { e.stopPropagation(); const fontId = parseInt(target.dataset.fontId, 10); await deleteFontFromDb(fontId); renderSavedFontsList(); } else { const item = target.closest('.saved-font-item'); if (item) { const fontId = parseInt(item.dataset.fontId, 10); const fonts = await getAllFontsFromDb(); const fontToApply = fonts.find(f => f.id === fontId); if (fontToApply) applySavedFont(fontToApply); } } });
            document.getElementById('upload-font-btn').addEventListener('click', () => controls.font.fileInput.click());
            controls.font.fileInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const suggestedName = file.name.split('.').slice(0, -1).join('.') || '本地字体'; openEditModal('为字体命名', suggestedName, async (newName) => { if (newName) { const newFont = { name: newName, type: 'data', value: file }; await addFontToDb(newFont); renderSavedFontsList(); applySavedFont(newFont); } }, true); });
            controls.font.urlInput.addEventListener('blur', (e) => { const url = e.target.value.trim(); if (!url) return; let suggestedName = '网络字体'; try { const urlPath = new URL(url).pathname; const fileName = urlPath.split('/').pop(); if (/\.(woff2?|ttf|otf)$/i.test(fileName)) { suggestedName = fileName; } } catch (error) {} openEditModal('为字体命名', suggestedName, async (newName) => { if (newName) { const newFont = { name: newName, type: 'url', value: url }; await addFontToDb(newFont); renderSavedFontsList(); applySavedFont(newFont); } }, true); });
            controls.wallpaper.previewEnabledCheckbox.addEventListener('change', (e) => { controls.wallpaper.previewSection.style.display = e.target.checked ? 'block' : 'none'; });
            document.getElementById('upload-wallpaper-btn').addEventListener('click', () => document.getElementById('wallpaper-file-input').click());
            document.getElementById('wallpaper-file-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => applyWallpaper(e.target.result); reader.readAsDataURL(file); } });
            controls.wallpaper.urlInput.addEventListener('blur', (e) => applyWallpaper(e.target.value.trim()));
            controls.wallpaper.restoreBtn.addEventListener('click', () => { applyWallpaper(null); controls.wallpaper.urlInput.value = ''; });
            controls.theme.hexInput.addEventListener('input', (e) => { const newColor = e.target.value; if (/^#([0-9A-F]{3}){1,2}$/i.test(newColor)) { applyThemeColor(newColor); } });
            controls.theme.restoreBtn.addEventListener('click', () => { controls.theme.hexInput.value = '#e8f0e9'; applyThemeColor('#e8f0e9'); });
            controls.dock.whiteBgToggle.addEventListener('change', updateDockAppearance);
            controls.dock.opacitySlider.addEventListener('input', updateDockAppearance);
            controls.dock.restoreBtn.addEventListener('click', () => { controls.dock.whiteBgToggle.checked = false; controls.dock.opacitySlider.value = 0.85; updateDockAppearance(); });
            controls.avatarFrame.toggle.addEventListener('change', applyAvatarFrame);
            controls.avatarFrame.uploadBtn.addEventListener('click', () => controls.avatarFrame.fileInput.click());
            controls.avatarFrame.fileInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { if (currentAvatarFrameURL) URL.revokeObjectURL(currentAvatarFrameURL); currentAvatarFrameURL = URL.createObjectURL(file); controls.avatarFrame.urlInput.value = currentAvatarFrameURL; applyAvatarFrame(); } });
            controls.avatarFrame.urlInput.addEventListener('input', () => { if (currentAvatarFrameURL && !controls.avatarFrame.urlInput.value.startsWith('blob:')) { URL.revokeObjectURL(currentAvatarFrameURL); currentAvatarFrameURL = null; } applyAvatarFrame(); });
            [controls.avatarFrame.xSlider, controls.avatarFrame.ySlider, controls.avatarFrame.scaleSlider].forEach(slider => slider.addEventListener('input', applyAvatarFrameTransform));
            controls.avatarFrame.restoreBtn.addEventListener('click', () => { controls.avatarFrame.toggle.checked = false; controls.avatarFrame.urlInput.value = ''; controls.avatarFrame.fileInput.value = ''; controls.avatarFrame.xSlider.value = 0; controls.avatarFrame.ySlider.value = 0; controls.avatarFrame.scaleSlider.value = 1; if (currentAvatarFrameURL) { URL.revokeObjectURL(currentAvatarFrameURL); currentAvatarFrameURL = null; } applyAvatarFrame(); applyAvatarFrameTransform(); });
            setupImageUpload('avatar-container', 'avatar-upload', (result) => { document.getElementById('avatar-container').style.backgroundImage = `url('${result}')`; document.getElementById('preview-avatar').style.backgroundImage = `url('${result}')`; });
            setupImageUpload('profile-banner', 'banner-upload', (result) => document.getElementById('profile-banner').style.backgroundImage = `url('${result}')`);
            setupImageUpload('widget-left', 'widget-left-upload', (result) => document.getElementById('widget-left').style.backgroundImage = `url('${result}')`);
            
            const iconGroups = [ { title: 'App', count: 4, prefix: 'app-icon-' }, { title: '底部栏图标', count: 4, prefix: 'dock-icon-' } ];
            iconGroups.forEach(group => { for (let i = 1; i <= group.count; i++) { const controlHtml = `<div class="icon-setting-group"><h4>${group.title} ${i} 图标</h4><div class="control-group"><button class="btn" data-target="${group.prefix}${i}">上传</button><input type="file" data-target="${group.prefix}${i}" accept="image/*" style="display:none;"><input type="text" data-target="${group.prefix}${i}" class="input-field" placeholder="或输入图片URL"></div></div>`; controls.icon.container.innerHTML += controlHtml; } });
            controls.icon.container.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { const targetId = e.target.dataset.target; controls.icon.container.querySelector(`input[type="file"][data-target="${targetId}"]`).click(); } });
            controls.icon.container.addEventListener('change', (e) => { if (e.target.type === 'file') { const file = e.target.files[0]; const targetId = e.target.dataset.target; if (file) { const reader = new FileReader(); reader.onload = (re) => { const iconEl = document.getElementById(targetId); iconEl.style.backgroundImage = `url('${re.target.result}')`; iconEl.style.backgroundColor = 'transparent'; }; reader.readAsDataURL(file); } } });
            controls.icon.container.addEventListener('input', (e) => { if (e.target.type === 'text') { const url = e.target.value.trim(); const targetId = e.target.dataset.target; const iconEl = document.getElementById(targetId); if (url) { iconEl.style.backgroundImage = `url('${url}')`; iconEl.style.backgroundColor = 'transparent'; } else { iconEl.style.backgroundImage = 'none'; iconEl.style.backgroundColor = 'var(--card-bg)'; } } });
            controls.icon.restoreBtn.addEventListener('click', () => { controls.icon.container.querySelectorAll('input[type="text"]').forEach(input => input.value = ''); iconGroups.forEach(group => { for (let i = 1; i <= group.count; i++) { const iconEl = document.getElementById(`${group.prefix}${i}`); iconEl.style.backgroundImage = 'none'; iconEl.style.backgroundColor = 'var(--card-bg)'; } }); });

            updateFontPreview(); applyThemeColor(controls.theme.hexInput.value); applyAvatarFrame(); applyAvatarFrameTransform();
        }
        return { init };
    })();

    // --- 5. API 配置APP逻辑 ---
    const apiConfigLogic = (() => {
        const controls = { provider: document.getElementById('api-provider-select'), urlInput: document.getElementById('api-url-input'), keyInput: document.getElementById('api-key-input'), keyTextarea: document.getElementById('api-key-textarea'), toggleKey: document.getElementById('toggle-api-key-visibility'), model: document.getElementById('api-model-select'), testBtn: document.getElementById('test-connection-btn'), saveBtn: document.getElementById('save-api-settings-btn'), restoreBtn: document.getElementById('restore-api-defaults-btn'), status: document.getElementById('connection-status') };
        const pageControls = { title: document.getElementById('api-page-title'), configView: document.getElementById('api-config-view'), presetsView: document.getElementById('api-presets-view'), navConfigBtn: document.getElementById('nav-config-btn'), navPresetsBtn: document.getElementById('nav-presets-btn'), presetsListContainer: document.getElementById('presets-list-container') };
        const CORS_PROXY_URL = 'https://corsproxy.io/?';
        const providerData = { openai: { url: 'https://api.openai.com/v1', useProxy: true, testable: true }, deepseek: { url: 'https://api.deepseek.com/v1', useProxy: true, testable: true }, gemini: { url: 'https://generativelanguage.googleapis.com/v1beta', useProxy: true, testable: true, modelsEndpoint: true }, claude: { url: 'https://api.anthropic.com/v1', useProxy: true, testable: false, modelsEndpoint: false }, reverse_proxy: { url: '', useProxy: false, testable: true }, custom: { url: '', useProxy: false, testable: true }, polling: { url: '', useProxy: false, testable: true } };

        function updateApiStatusIndicator(isConnected) { document.body.classList.remove('api-connected', 'api-disconnected'); document.body.classList.add(isConnected ? 'api-connected' : 'api-disconnected'); }
        function showApiSubPage(pageName) { pageControls.configView.classList.remove('active'); pageControls.presetsView.classList.remove('active'); pageControls.navConfigBtn.classList.remove('active'); pageControls.navPresetsBtn.classList.remove('active'); if (pageName === 'config') { pageControls.configView.classList.add('active'); pageControls.navConfigBtn.classList.add('active'); pageControls.title.textContent = 'API 配置'; } else if (pageName === 'presets') { pageControls.presetsView.classList.add('active'); pageControls.navPresetsBtn.classList.add('active'); pageControls.title.textContent = '我的预设'; renderApiPresets(); } }
        function getApiPresets() { return JSON.parse(localStorage.getItem('apiPresets')) || []; }
        function saveApiPresets(presets) { localStorage.setItem('apiPresets', JSON.stringify(presets)); }
        function renderApiPresets() { const presets = getApiPresets(); pageControls.presetsListContainer.innerHTML = ''; if (presets.length === 0) { pageControls.presetsListContainer.innerHTML = `<p style="text-align:center; color: var(--text-light-fixed);">暂无预设，请在“配置”页面连接成功后保存。</p>`; return; } presets.forEach((preset, index) => { const item = document.createElement('div'); item.className = 'preset-list-item'; item.innerHTML = `<span class="preset-name">${preset.name}</span><div class="preset-actions"><button class="btn btn-sm btn-apply">应用</button><button class="btn btn-sm btn-delete">删除</button></div>`; item.querySelector('.btn-apply').addEventListener('click', () => loadApiPreset(index)); item.querySelector('.btn-delete').addEventListener('click', () => deleteApiPreset(index)); pageControls.presetsListContainer.appendChild(item); }); }
        function loadApiPreset(index) { const presets = getApiPresets(); if (presets[index]) { applyApiSettings(presets[index].settings); alert(`预设 “${presets[index].name}” 已应用并加载模型！`); showApiSubPage('config'); } }
        function deleteApiPreset(index) { const presets = getApiPresets(); if (!confirm(`确定要删除预设 “${presets[index].name}” 吗？`)) return; presets.splice(index, 1); saveApiPresets(presets); renderApiPresets(); }
        async function fetchApiModels(provider, url, key, useProxy) { controls.status.textContent = '正在拉取模型列表...'; controls.status.className = ''; updateApiStatusIndicator(false); let finalUrl, reqOptions; const baseUrl = useProxy ? CORS_PROXY_URL + encodeURIComponent(url) : url; if (provider === 'gemini') { finalUrl = `${baseUrl.replace(/\/$/, "")}/models?key=${key}`; reqOptions = { method: 'GET', headers: { 'Content-Type': 'application/json' }, mode: 'cors' }; } else { finalUrl = `${baseUrl.replace(/\/$/, "")}/models`; reqOptions = { method: 'GET', headers: { 'Authorization': `Bearer ${key}` }, mode: 'cors' }; } try { const response = await fetch(finalUrl, reqOptions); if (!response.ok) { let errorDetail = `HTTP ${response.status}: ${response.statusText}`; try { const errorData = await response.json(); errorDetail = errorData.error?.message || JSON.stringify(errorData); } catch (e) {} let hint = ''; switch (response.status) { case 400: hint = ' (通常表示API Key格式错误)'; break; case 401: case 403: hint = ' (请检查API Key是否正确或有权限)'; break; case 404: hint = ' (请检查API URL是否正确)'; break; case 429: hint = ' (请求频率过高，请稍后再试)'; break; } throw new Error(`${errorDetail}${hint}`); } const data = await response.json(); controls.status.textContent = '模型列表拉取成功！'; controls.status.classList.add('success'); updateApiStatusIndicator(true); let models; if (provider === 'gemini') { if (!data.models || !Array.isArray(data.models)) throw new Error('Gemini响应格式不正确'); models = data.models.filter(model => model.supportedGenerationMethods && model.supportedGenerationMethods.includes('generateContent')).map(model => model.name.replace('models/', '')).sort(); } else { const modelData = data.data || data; if (!Array.isArray(modelData)) throw new Error('响应格式不正确'); models = modelData.map(model => model.id).sort(); } if (models.length === 0) { controls.status.textContent = '成功连接，但未找到可用模型。'; controls.status.classList.add('error'); updateApiStatusIndicator(false); } return models; } catch (error) { let finalErrorMessage = `拉取失败: ${error.message}`; if (error.name === 'TypeError') { finalErrorMessage += '\n(可能因网络问题或CORS跨域策略导致)'; } controls.status.textContent = finalErrorMessage; controls.status.classList.add('error'); updateApiStatusIndicator(false); return []; } }
        function updateControlsForProvider() { const provider = controls.provider.value; const data = providerData[provider]; controls.urlInput.value = data.url; const isPolling = provider === 'polling'; controls.keyInput.style.display = isPolling ? 'none' : 'block'; controls.keyTextarea.style.display = isPolling ? 'block' : 'none'; controls.toggleKey.style.display = isPolling ? 'none' : 'inline-block'; controls.model.innerHTML = ''; const placeholderText = data.testable === false ? '此服务商不支持自动拉取模型' : '请先进行连接测试来拉取模型'; const option = document.createElement('option'); option.textContent = placeholderText; controls.model.appendChild(option); }
        function getCurrentApiSettings(modelsList = []) { const provider = controls.provider.value; return { provider: provider, url: controls.urlInput.value, key: provider === 'polling' ? controls.keyTextarea.value : controls.keyInput.value, model: controls.model.value, models: modelsList }; }
        function applyApiSettings(settings) { controls.provider.value = settings.provider || 'openai'; updateControlsForProvider(); controls.urlInput.value = settings.url; if (settings.provider === 'polling') { controls.keyTextarea.value = settings.key; } else { controls.keyInput.value = settings.key; } controls.model.innerHTML = ''; if (settings.models && settings.models.length > 0) { settings.models.forEach(modelName => { const option = document.createElement('option'); option.value = modelName; option.textContent = modelName; controls.model.appendChild(option); }); controls.status.textContent = '预设已应用，模型列表已加载。'; controls.status.className = 'success'; updateApiStatusIndicator(true); } else { const option = document.createElement('option'); option.textContent = '请先进行连接测试来拉取模型'; controls.model.appendChild(option); controls.status.textContent = ''; controls.status.className = ''; updateApiStatusIndicator(false); } controls.model.value = settings.model; }
        function saveCurrentApiSettings() { localStorage.setItem('apiSettings', JSON.stringify(getCurrentApiSettings(Array.from(controls.model.options).map(o => o.value)))); alert('API 设置已保存!'); }
        function loadLastApiSettings() { const settingsJSON = localStorage.getItem('apiSettings'); if (settingsJSON) { applyApiSettings(JSON.parse(settingsJSON)); } else { updateControlsForProvider(); updateApiStatusIndicator(false); } }
        function isExistingApiPreset(currentSettings) { const presets = getApiPresets(); return presets.some(p => p.settings.provider === currentSettings.provider && p.settings.url === currentSettings.url && p.settings.key === currentSettings.key); }
        async function testAndFetchApi() { const provider = controls.provider.value, config = providerData[provider]; if (!config.testable) { controls.status.textContent = '此服务商不支持自动拉取模型。'; return; } const url = controls.urlInput.value.trim(); let key = provider === 'polling' ? controls.keyTextarea.value.split('\n')[0].trim() : controls.keyInput.value.trim(); if ((provider !== 'polling' && !key) || !url) { controls.status.textContent = 'URL 和 Key 不能为空。'; controls.status.classList.add('error'); return; } const models = await fetchApiModels(provider, url, key, config.useProxy); if (models.length > 0) { const currentModel = controls.model.value; controls.model.innerHTML = ''; models.forEach(modelName => { const option = document.createElement('option'); option.value = modelName; option.textContent = modelName; controls.model.appendChild(option); }); if (models.includes(currentModel)) { controls.model.value = currentModel; } if (!isExistingApiPreset(getCurrentApiSettings(models))) { const result = await showPrompt({title:'连接成功！', html:`<div class="form-group"><label for="prompt-name">为此配置命名以保存为预设</label><input type="text" id="prompt-name" class="input-field" placeholder="请输入名称..."></div>`}); if (result && result.name && result.name.trim()) { const presets = getApiPresets(); const newPreset = { name: result.name.trim(), settings: getCurrentApiSettings(models) }; presets.push(newPreset); saveApiPresets(presets); alert(`预设 “${result.name.trim()}” 已保存！`); } } } }

        function init() {
            document.getElementById('dock-icon-2-trigger').addEventListener('click', () => showPage('api-config-page'));
            pageControls.navConfigBtn.addEventListener('click', () => showApiSubPage('config'));
            pageControls.navPresetsBtn.addEventListener('click', () => showApiSubPage('presets'));
            controls.provider.addEventListener('change', updateControlsForProvider);
            controls.toggleKey.addEventListener('click', () => { controls.keyInput.type = controls.keyInput.type === 'password' ? 'text' : 'password'; });
            controls.saveBtn.addEventListener('click', saveCurrentApiSettings);
            controls.testBtn.addEventListener('click', testAndFetchApi);
            controls.restoreBtn.addEventListener('click', () => { if(confirm('确定要恢复为默认出厂设置吗？')){localStorage.removeItem('apiSettings'); controls.provider.value = 'openai'; controls.keyInput.value = ''; controls.keyTextarea.value = ''; loadLastApiSettings(); alert('已恢复默认设置。');} });
            loadLastApiSettings(); showApiSubPage('config');
        }
        return { init, updateApiStatusIndicator };
    })();

    // --- 6. 角色书 & 用户人设 APP逻辑 ---
    const charBookLogic = (() => {
        const charListPage = { 
            title: document.getElementById('char-book-title'),
            contentArea: document.getElementById('char-list-content-area'), 
            addButton: document.getElementById('char-add-button'), 
            addMenu: document.getElementById('char-add-menu'), 
            addNewItemBtn: document.getElementById('char-add-new-item-btn'), 
            importJsonBtn: document.getElementById('char-import-json-btn'), 
            jsonCharInput: document.getElementById('char-json-char-input'), 
            manageGroupsBtn: document.getElementById('char-manage-groups-btn'), 
        };
        const charEditorPage = { 
            page: document.getElementById('char-editor-page'), 
            title: document.getElementById('char-editor-title'), 
            saveButton: document.getElementById('save-char-button'), 
            deleteBtnContainer: document.getElementById('delete-button-container'), 
            deleteButton: document.getElementById('delete-char-button'), 
            avatarPreview: document.getElementById('char-avatar-preview'),
            avatarUrlInput: document.getElementById('char-avatar-url'), 
            avatarFileInput: document.getElementById('char-avatar-file-input'), 
            nameInput: document.getElementById('char-name'), 
            groupSelect: document.getElementById('char-group'), 
            worldBookSelect: document.getElementById('char-worldbook-select'), 
            bioInput: document.getElementById('char-bio'), 
            descTextarea: document.getElementById('char-desc'), 
            onlineSwitch: document.getElementById('online-opening-switch'), 
            onlineContainer: document.getElementById('online-opening-container'), 
            offlineSwitch: document.getElementById('offline-opening-switch'), 
            offlineContainer: document.getElementById('offline-opening-container'), 
            addOnlineGreetingBtn: document.getElementById('add-online-greeting'), 
            addOfflineGreetingBtn: document.getElementById('add-offline-greeting'), 
        };
        const userPersonaEditorPage = {
            page: document.getElementById('user-persona-editor-page'),
            title: document.getElementById('user-persona-editor-title'),
            saveButton: document.getElementById('save-user-persona-button'),
            deleteBtnContainer: document.getElementById('delete-user-persona-container'),
            deleteButton: document.getElementById('delete-user-persona-button'),
            avatarPreview: document.getElementById('user-persona-avatar-preview'),
            avatarUrlInput: document.getElementById('user-persona-avatar-url'),
            avatarFileInput: document.getElementById('user-persona-avatar-file-input'),
            nameInput: document.getElementById('user-persona-name'),
            groupSelect: document.getElementById('user-persona-group'),
            bioInput: document.getElementById('user-persona-bio'),
            descTextarea: document.getElementById('user-persona-desc'),
            memoryTextarea: document.getElementById('user-persona-memory'),
        };
        const groupManagerPage = { 
            page: document.getElementById('char-group-manager-page'), 
            title: document.getElementById('group-manager-title'),
            contentArea: document.getElementById('group-manager-content'), 
            addNewGroupBtn: document.getElementById('add-new-group-btn'), 
        };
        
        function toggleCharBookView() {
            globalState.characterBookView = (globalState.characterBookView === 'char') ? 'user' : 'char';
            updateCharBookView();
        }

        function updateCharBookView() {
            const isCharView = globalState.characterBookView === 'char';
            charListPage.title.textContent = isCharView ? '角色书 (Char)' : '用户人设 (User)';
            charListPage.addNewItemBtn.textContent = isCharView ? '新建角色书' : '新建用户人设';
            charListPage.importJsonBtn.style.display = isCharView ? 'block' : 'none';
            renderList();
        }

        function renderList() {
            const isCharView = globalState.characterBookView === 'char';
            const area = charListPage.contentArea;
            const items = isCharView ? globalState.characters : globalState.userPersonas;
            const groups = isCharView ? globalState.characterGroups : globalState.userPersonaGroups;
            
            area.innerHTML = '';
            if (items.length === 0) {
                area.innerHTML = `<p class="empty-placeholder">空空如也~<br>点击右上角“+”来创建第一个${isCharView ? '角色' : '人设'}吧！</p>`;
                return;
            }
            
            groups.forEach(groupName => {
                const itemsInGroup = items.filter(item => item.group === groupName);
                if (itemsInGroup.length === 0) return;
                
                const isCollapsed = isCharView ? globalState.characterCollapsedGroups.includes(groupName) : false; // User personas don't have collapse state for now
                const groupHeader = document.createElement('div');
                groupHeader.className = 'list-group-header' + (isCollapsed ? ' collapsed' : '');
                groupHeader.dataset.groupName = groupName;
                groupHeader.innerHTML = `<span>${groupName}</span><span class="list-toggle-arrow">▲</span>`;
                area.appendChild(groupHeader);
                
                const cardContainer = document.createElement('div');
                cardContainer.className = 'list-card-container' + (isCollapsed ? ' collapsed' : '');
                cardContainer.innerHTML = itemsInGroup.map(item => `
                    <div class="character-card" data-id="${item.id}">
                        <div class="card-avatar" style="background-image: url('${item.avatar || `https://dummyimage.com/100x100/e8f0e9/5a6e60.png&text=${encodeURIComponent(item.name.charAt(0))}` }');"></div>
                        <div class="card-content">
                            <h4 class="card-title">${item.name}</h4>
                            <p class="card-description">${item.bio || '暂无简介'}</p>
                        </div>
                    </div>`).join('');
                area.appendChild(cardContainer);
            });
        }
        
        function renderGroupManager() {
            const isCharView = globalState.currentGroupManagementContext === 'char';
            groupManagerPage.title.textContent = isCharView ? '角色分组管理' : '人设分组管理';
            const area = groupManagerPage.contentArea;
            const items = isCharView ? globalState.characters : globalState.userPersonas;
            const groups = isCharView ? globalState.characterGroups : globalState.userPersonaGroups;
            const defaultGroup = isCharView ? '默认分组' : '默认分组';

            area.innerHTML = '';
            groups.forEach(groupName => {
                const isDefault = groupName === defaultGroup;
                const itemsInGroup = items.filter(item => item.group === groupName);
                const itemsHTML = itemsInGroup.length > 0 ? itemsInGroup.map(item => `<div class="group-manage-content-item" data-id="${item.id}"><span>${item.name}</span></div>`).join('') : '<p style="font-size:0.85em; color:var(--text-light-fixed); text-align:center; padding: 10px 0;">此分组下无项目</p>';
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group-manage-item';
                groupDiv.innerHTML = `
                    <div class="group-manage-header">
                        <h3 data-group-name="${groupName}" class="${!isDefault ? 'clickable' : ''}">${groupName}</h3>
                        ${!isDefault ? `<button class="action-button-generic delete-group-btn" data-group-name="${groupName}" aria-label="删除分组"><svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>` : ''}
                    </div>
                    <div class="group-manage-content">${itemsHTML}</div>`;
                area.appendChild(groupDiv);
            });
        }

        function addGreetingItem(container, type, content = '') { const itemCount = container.querySelectorAll('.greeting-item').length; const details = document.createElement('details'); details.className = 'greeting-item'; details.open = true; details.innerHTML = `<summary><span class="summary-title">${type}开场白 #${itemCount + 1}</span><span class="summary-controls"><button class="delete-greeting-btn" aria-label="删除此开场白"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button><span class="greeting-arrow">▶</span></span></summary><textarea class="greeting-textarea" placeholder="请输入...">${content}</textarea>`; container.appendChild(details); }
        function renderGreetingItems(container, greetings, type) { container.innerHTML = ''; greetings.forEach((greeting, index) => { addGreetingItem(container, type, greeting); if (index > 0) container.lastChild.open = false; }); }
        
        function openCharEditor(charId = null) {
            globalState.editingCharId = charId;
            const page = charEditorPage;
            page.avatarPreview.style.backgroundImage = ''; page.avatarPreview.dataset.imageData = ''; page.avatarUrlInput.value = ''; page.nameInput.value = ''; page.bioInput.value = ''; page.descTextarea.value = ''; page.onlineSwitch.checked = false; page.onlineContainer.innerHTML = ''; page.offlineSwitch.checked = false; page.offlineContainer.innerHTML = '';
            page.groupSelect.innerHTML = globalState.characterGroups.map(g => `<option value="${g}">${g}</option>`).join('');
            const wbOptions = globalState.worldBooks.map(book => `<option value="${book.id}">${book.name}</option>`);
            page.worldBookSelect.innerHTML = `<option value="">不绑定</option>` + wbOptions.join('');
            
            if (charId) {
                const item = globalState.characters.find(i => i.id === charId); if (!item) return;
                page.title.textContent = `编辑角色`;
                if (item.avatar) { page.avatarPreview.style.backgroundImage = `url(${item.avatar})`; page.avatarPreview.dataset.imageData = item.avatar; page.avatarUrlInput.value = item.avatar.startsWith('data:image') ? '' : item.avatar; }
                page.nameInput.value = item.name; page.groupSelect.value = item.group; page.bioInput.value = item.bio; page.descTextarea.value = item.description;
                page.worldBookSelect.value = item.boundWorldBookId || "";

                let onlineGreetings = item.onlineOpening?.greetings || (item.onlineOpening?.text ? item.onlineOpening.text.split('\n\n').filter(Boolean) : []);
                page.onlineSwitch.checked = onlineGreetings.length > 0;
                renderGreetingItems(page.onlineContainer, onlineGreetings, '线上');

                let offlineGreetings = item.offlineOpening?.greetings || (item.offlineOpening?.text ? item.offlineOpening.text.split('\n\n').filter(Boolean) : []);
                page.offlineSwitch.checked = offlineGreetings.length > 0;
                renderGreetingItems(page.offlineContainer, offlineGreetings, '线下');

                page.deleteBtnContainer.style.display = 'block';
            } else { 
                page.title.textContent = `新建角色`; 
                page.groupSelect.value = '默认分组'; 
                page.worldBookSelect.value = ""; 
                page.deleteBtnContainer.style.display = 'none'; 
            }
            page.onlineContainer.style.display = page.onlineSwitch.checked ? 'block' : 'none';
            page.offlineContainer.style.display = page.offlineSwitch.checked ? 'block' : 'none';
            showPage('char-editor-page');
        }

        function openUserPersonaEditor(personaId = null) {
            globalState.editingUserPersonaId = personaId;
            const page = userPersonaEditorPage;
            page.avatarPreview.style.backgroundImage = ''; page.avatarPreview.dataset.imageData = ''; page.avatarUrlInput.value = ''; page.nameInput.value = ''; page.bioInput.value = ''; page.descTextarea.value = ''; page.memoryTextarea.value = '';
            page.groupSelect.innerHTML = globalState.userPersonaGroups.map(g => `<option value="${g}">${g}</option>`).join('');

            if (personaId) {
                const item = globalState.userPersonas.find(i => i.id === personaId); if (!item) return;
                page.title.textContent = '编辑用户人设';
                if (item.avatar) { page.avatarPreview.style.backgroundImage = `url(${item.avatar})`; page.avatarPreview.dataset.imageData = item.avatar; page.avatarUrlInput.value = item.avatar.startsWith('data:image') ? '' : item.avatar; }
                page.nameInput.value = item.name;
                page.groupSelect.value = item.group;
                page.bioInput.value = item.bio;
                page.descTextarea.value = item.description;
                page.memoryTextarea.value = item.memory;
                page.deleteBtnContainer.style.display = 'block';
            } else {
                page.title.textContent = '新建用户人设';
                page.groupSelect.value = '默认分组';
                page.deleteBtnContainer.style.display = 'none';
            }
            showPage('user-persona-editor-page');
        }

        function openCharEditorWithJsonData(data) { 
            openCharEditor(null); 
            charEditorPage.title.textContent = `导入角色：${data.name}`; 
            charEditorPage.nameInput.value = data.name || ''; 
            charEditorPage.bioInput.value = data.bio || '从JSON文件导入'; 
            charEditorPage.descTextarea.value = data.description || ''; 
            if (data.avatar && data.avatar !== 'none') { 
                charEditorPage.avatarPreview.style.backgroundImage = `url(${data.avatar})`;
                charEditorPage.avatarPreview.dataset.imageData = data.avatar; 
                charEditorPage.avatarUrlInput.value = data.avatar; 
            } 
            charEditorPage.onlineSwitch.checked = data.onlineOpening?.enabled || false; 
            renderGreetingItems(charEditorPage.onlineContainer, data.onlineOpening.greetings, '线上'); 
            charEditorPage.onlineContainer.style.display = charEditorPage.onlineSwitch.checked ? 'block' : 'none'; 
            charEditorPage.offlineSwitch.checked = data.offlineOpening?.enabled || false; 
            renderGreetingItems(charEditorPage.offlineContainer, data.offlineOpening.greetings, '线下'); 
            charEditorPage.offlineContainer.style.display = charEditorPage.offlineSwitch.checked ? 'block' : 'none'; 
            if (data.boundWorldBookId) { 
                charEditorPage.worldBookSelect.value = data.boundWorldBookId; 
            } 
        }

        function saveCharacter() {
            const getGreetingsFromContainer = (container) =>
                Array.from(container.querySelectorAll('.greeting-textarea'))
                     .map(textarea => textarea.value)
                     .filter(text => text.trim());

            const data = {
                id: globalState.editingCharId || `char_${Date.now()}`,
                avatar: charEditorPage.avatarPreview.dataset.imageData || '',
                name: charEditorPage.nameInput.value.trim(),
                group: charEditorPage.groupSelect.value,
                bio: charEditorPage.bioInput.value.trim(),
                description: charEditorPage.descTextarea.value.trim(),
                onlineOpening: {
                    enabled: charEditorPage.onlineSwitch.checked,
                    greetings: getGreetingsFromContainer(charEditorPage.onlineContainer)
                },
                offlineOpening: {
                    enabled: charEditorPage.offlineSwitch.checked,
                    greetings: getGreetingsFromContainer(charEditorPage.offlineContainer)
                },
                boundWorldBookId: charEditorPage.worldBookSelect.value,
            };
            if (!data.name) { alert('名字不能为空哦！'); return; }
            if (globalState.editingCharId) {
                const itemIndex = globalState.characters.findIndex(i => i.id === globalState.editingCharId);
                if (itemIndex > -1) globalState.characters[itemIndex] = data;
            } else {
                globalState.characters.push(data);
            }
            renderList();
            goBack();
        }

        function saveUserPersona() {
            const page = userPersonaEditorPage;
            const data = {
                id: globalState.editingUserPersonaId || `user_${Date.now()}`,
                avatar: page.avatarPreview.dataset.imageData || '',
                name: page.nameInput.value.trim(),
                group: page.groupSelect.value,
                bio: page.bioInput.value.trim(),
                description: page.descTextarea.value.trim(),
                memory: page.memoryTextarea.value.trim(),
            };
            if (!data.name) { alert('名字不能为空哦！'); return; }
            if (globalState.editingUserPersonaId) {
                const itemIndex = globalState.userPersonas.findIndex(i => i.id === globalState.editingUserPersonaId);
                if (itemIndex > -1) globalState.userPersonas[itemIndex] = data;
            } else {
                globalState.userPersonas.push(data);
            }
            renderList();
            goBack();
        }

        function renumberGreetings(container, type) { container.querySelectorAll('.greeting-item').forEach((item, index) => { const titleSpan = item.querySelector('.summary-title'); if (titleSpan) titleSpan.textContent = `${type}开场白 #${index + 1}`; }); }
        
        function init() {
            document.getElementById('dock-icon-4-trigger').addEventListener('click', () => { updateCharBookView(); showPage('char-list-page'); });
            charListPage.title.addEventListener('click', toggleCharBookView);
            charListPage.addButton.addEventListener('click', (e) => { e.stopPropagation(); charListPage.addMenu.classList.toggle('visible'); });
            window.addEventListener('click', () => { if (charListPage.addMenu.classList.contains('visible')) charListPage.addMenu.classList.remove('visible'); });
            
            charListPage.addNewItemBtn.addEventListener('click', () => { 
                charListPage.addMenu.classList.remove('visible');
                if (globalState.characterBookView === 'char') {
                    openCharEditor();
                } else {
                    openUserPersonaEditor();
                }
            });

            charListPage.manageGroupsBtn.addEventListener('click', () => { 
                charListPage.addMenu.classList.remove('visible');
                globalState.currentGroupManagementContext = globalState.characterBookView;
                renderGroupManager(); 
                showPage('char-group-manager-page'); 
            });

            charListPage.importJsonBtn.addEventListener('click', (e) => { e.preventDefault(); charListPage.addMenu.classList.remove('visible'); charListPage.jsonCharInput.click(); });
            charListPage.jsonCharInput.addEventListener('change', (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const parsedData = JSON.parse(event.target.result);
                        if (parsedData.data && parsedData.data.name) {
                            const charData = parsedData.data;
                            const onlineGreetings = [], offlineGreetings = [], allGreetings = [];
                            if (charData.first_mes && charData.first_mes.trim() !== '【开场】') allGreetings.push(charData.first_mes.trim());
                            if (charData.alternate_greetings && Array.isArray(charData.alternate_greetings)) allGreetings.push(...charData.alternate_greetings.filter(g => typeof g === 'string' && g.trim()));
                            allGreetings.forEach(greeting => { (greeting.includes('[和') || greeting.includes('[我方消息]') || greeting.includes('[对方消息]')) ? onlineGreetings.push(greeting) : offlineGreetings.push(greeting); });
                            const processedCharData = { name: charData.name, description: charData.description || '', bio: charData.creator_notes || '', avatar: (charData.avatar && charData.avatar !== 'none') ? charData.avatar : '', onlineOpening: { enabled: onlineGreetings.length > 0, greetings: onlineGreetings }, offlineOpening: { enabled: offlineGreetings.length > 0, greetings: offlineGreetings }, boundWorldBookId: null };
                            if (charData.world_book && charData.world_book.entries && Object.keys(charData.world_book.entries).length > 0) {
                                const newBookId = `wb_${Date.now()}`;
                                const newBook = { id: newBookId, name: `${charData.name} 的专属世界书`, description: `从角色卡 “${charData.name}” 自动导入`, group: "未分组", entries: charData.world_book.entries };
                                globalState.worldBooks.push(newBook);
                                processedCharData.boundWorldBookId = newBookId;
                                alert(`已为角色 “${charData.name}” 自动导入并创建了专属世界书！`);
                            }
                            openCharEditorWithJsonData(processedCharData);
                        } else { alert('无法识别的角色卡JSON格式！'); }
                    } catch (error) { alert('解析JSON文件失败。'); console.error(error); }
                };
                reader.readAsText(file); e.target.value = '';
            });

            charListPage.contentArea.addEventListener('click', (e) => {
                const groupHeader = e.target.closest('.list-group-header');
                if (groupHeader) {
                    const groupName = groupHeader.dataset.groupName;
                    if (globalState.characterBookView === 'char') {
                        const index = globalState.characterCollapsedGroups.indexOf(groupName);
                        if (index > -1) {
                            globalState.characterCollapsedGroups.splice(index, 1);
                        } else {
                            globalState.characterCollapsedGroups.push(groupName);
                        }
                        renderList();
                    }
                    return;
                }
                const card = e.target.closest('.character-card');
                if (card) {
                    if (globalState.characterBookView === 'char') {
                        openCharEditor(card.dataset.id);
                    } else {
                        openUserPersonaEditor(card.dataset.id);
                    }
                }
            });

            // 角色编辑器事件
            charEditorPage.page.addEventListener('click', (e) => { const deleteBtn = e.target.closest('.delete-greeting-btn'); if (deleteBtn) { e.preventDefault(); const item = deleteBtn.closest('.greeting-item'); if (item) { const container = item.parentElement; const type = container.id.includes('online') ? '线上' : '线下'; item.remove(); renumberGreetings(container, type); } } });
            charEditorPage.saveButton.addEventListener('click', saveCharacter);
            charEditorPage.deleteButton.addEventListener('click', async () => { if (!globalState.editingCharId) return; const result = await showPrompt({ title: '删除确认', html: `<p>确定要删除角色 “${charEditorPage.nameInput.value}” 吗？<br>此操作不可撤销。</p>`, confirmText: '删除', confirmClass: 'btn-danger' }); if (result) { globalState.characters = globalState.characters.filter(i => i.id !== globalState.editingCharId); renderList(); goBack(); } });
            charEditorPage.avatarPreview.addEventListener('click', () => charEditorPage.avatarFileInput.click());
            charEditorPage.avatarUrlInput.addEventListener('blur', (e) => { const url = e.target.value.trim(); if (url) { charEditorPage.avatarPreview.style.backgroundImage = `url(${url})`; charEditorPage.avatarPreview.dataset.imageData = url; } });
            charEditorPage.avatarFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { const dataUri = event.target.result; charEditorPage.avatarPreview.style.backgroundImage = `url(${dataUri})`; charEditorPage.avatarPreview.dataset.imageData = dataUri; charEditorPage.avatarUrlInput.value = ''; }; reader.readAsDataURL(file); } });
            charEditorPage.onlineSwitch.addEventListener('change', (e) => { charEditorPage.onlineContainer.style.display = e.target.checked ? 'block' : 'none'; });
            charEditorPage.offlineSwitch.addEventListener('change', (e) => { charEditorPage.offlineContainer.style.display = e.target.checked ? 'block' : 'none'; });
            charEditorPage.addOnlineGreetingBtn.addEventListener('click', () => { if (!charEditorPage.onlineSwitch.checked) { charEditorPage.onlineSwitch.checked = true; charEditorPage.onlineContainer.style.display = 'block'; } addGreetingItem(charEditorPage.onlineContainer, '线上'); });
            charEditorPage.addOfflineGreetingBtn.addEventListener('click', () => { if (!charEditorPage.offlineSwitch.checked) { charEditorPage.offlineSwitch.checked = true; charEditorPage.offlineContainer.style.display = 'block'; } addGreetingItem(charEditorPage.offlineContainer, '线下'); });

            // 用户人设编辑器事件
            userPersonaEditorPage.saveButton.addEventListener('click', saveUserPersona);
            userPersonaEditorPage.deleteButton.addEventListener('click', async () => { if (!globalState.editingUserPersonaId) return; const result = await showPrompt({ title: '删除确认', html: `<p>确定要删除人设 “${userPersonaEditorPage.nameInput.value}” 吗？<br>此操作不可撤销。</p>`, confirmText: '删除', confirmClass: 'btn-danger' }); if (result) { globalState.userPersonas = globalState.userPersonas.filter(i => i.id !== globalState.editingUserPersonaId); renderList(); goBack(); } });
            userPersonaEditorPage.avatarPreview.addEventListener('click', () => userPersonaEditorPage.avatarFileInput.click());
            userPersonaEditorPage.avatarUrlInput.addEventListener('blur', (e) => { const url = e.target.value.trim(); if (url) { userPersonaEditorPage.avatarPreview.style.backgroundImage = `url(${url})`; userPersonaEditorPage.avatarPreview.dataset.imageData = url; } });
            userPersonaEditorPage.avatarFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { const dataUri = event.target.result; userPersonaEditorPage.avatarPreview.style.backgroundImage = `url(${dataUri})`; userPersonaEditorPage.avatarPreview.dataset.imageData = dataUri; userPersonaEditorPage.avatarUrlInput.value = ''; }; reader.readAsDataURL(file); } });

            // 分组管理事件
            groupManagerPage.page.addEventListener('click', async (e) => {
                const target = e.target;
                const context = globalState.currentGroupManagementContext;
                const items = context === 'char' ? globalState.characters : globalState.userPersonas;
                let groups = context === 'char' ? globalState.characterGroups : globalState.userPersonaGroups;
                const defaultGroup = '默认分组';

                if(target.closest('#add-new-group-btn')) {
                    const { name } = await showPrompt({title: "新建分组", html: `<div class="form-group"><label for="prompt-name">分组名称</label><input type="text" id="prompt-name" class="input-field" placeholder="请输入..."></div>`}) || {};
                    if (name && !groups.includes(name)) {
                        groups.push(name);
                        renderGroupManager();
                    } else if (name) {
                        alert('分组名称已存在！');
                    }
                } else if(target.closest('.delete-group-btn')) {
                    const groupName = target.closest('.delete-group-btn').dataset.groupName;
                    const result = await showPrompt({ title: '删除分组', html: `<p>确定要删除分组 “${groupName}” 吗？<br>该分组下的所有项目将被移至“${defaultGroup}”。</p>`, confirmText: '删除', confirmClass: 'btn-danger' });
                    if (result) {
                        items.forEach(item => { if (item.group === groupName) item.group = defaultGroup; });
                        if (context === 'char') {
                            globalState.characterGroups = groups.filter(g => g !== groupName);
                        } else {
                            globalState.userPersonaGroups = groups.filter(g => g !== groupName);
                        }
                        renderGroupManager();
                    }
                } else if(target.closest('.group-manage-header h3.clickable')) {
                    const oldName = target.closest('.group-manage-header h3.clickable').dataset.groupName;
                    const { name: newName } = await showPrompt({ title: `重命名分组`, html: `<div class="form-group"><label for="prompt-name">新名称</label><input type="text" id="prompt-name" class="input-field" value="${oldName}"></div>` }) || {};
                    if (newName && oldName !== newName) {
                        if (!groups.includes(newName)) {
                            const index = groups.indexOf(oldName);
                            if (index > -1) groups[index] = newName;
                            items.forEach(item => { if (item.group === oldName) item.group = newName; });
                            renderGroupManager();
                        } else {
                            alert('分组名称已存在！');
                        }
                    }
                } else if(target.closest('.group-manage-content-item[data-id]')) {
                    const itemId = target.closest('.group-manage-content-item[data-id]').dataset.id;
                    const item = items.find(i => i.id === itemId);
                    if (!item) return;
                    const result = await showPrompt({ title: `移动 “${item.name}”`, html: `<div class="form-group"><label for="prompt-group">选择新分组</label><select id="prompt-group" class="input-field">${groups.map(g => `<option value="${g}" ${g === item.group ? 'selected' : ''}>${g}</option>`).join('')}</select></div>` });
                    if (result && result.group) {
                        item.group = result.group;
                        renderGroupManager();
                    }
                }
            });
        }
        return { init };
    })();

    // --- 7. 世界书APP逻辑 ---
    const worldBookLogic = (() => {
        const pages = { mainHub: document.getElementById('wb-main-hub-page'), bookEditor: document.getElementById('wb-book-editor-page'), entryList: document.getElementById('wb-entry-list-page'), entryEditor: document.getElementById("wb-entry-editor-page"), presetEditor: document.getElementById('wb-preset-editor-page'), promptList: document.getElementById('wb-prompt-list-page'), groupManager: document.getElementById('wb-group-manager-page'), };
        const entryEditorFields = { title: document.getElementById('wb-entry-editor-title'), commentLabel: document.getElementById('wb-comment-label'), comment: document.getElementById('wb-comment'), content: document.getElementById('wb-content'), keys: document.getElementById('wb-keys'), position: document.getElementById('wb-position'), order: document.getElementById('wb-order'), depth: document.getElementById('wb-depth'), probability: document.getElementById('wb-probability'), enabled: document.getElementById('wb-enabled'), constant: document.getElementById('wb-constant'), selective: document.getElementById('wb-selective'), preventRecursion: document.getElementById('wb-prevent-recursion'), useProbability: document.getElementById('wb-use-probability'), worldbookOnlyFields: pages.entryEditor.querySelector('.worldbook-only') };
        const presetEditorFields = { name: document.getElementById('wb-preset-name'), group: document.getElementById('wb-preset-group'), description: document.getElementById('wb-preset-description'), temperature: { input: document.getElementById('wb-preset-temperature'), valueEl: document.getElementById('wb-preset-temperature-value') }, max_context: { input: document.getElementById('wb-preset-max-context'), valueEl: document.getElementById('wb-preset-max-context-value') }, top_p: { input: document.getElementById('wb-preset-top-p'), valueEl: document.getElementById('wb-preset-top-p-value') }, top_k: { input: document.getElementById('wb-preset-top-k'), valueEl: document.getElementById('wb-preset-top-k-value') }, freq_penalty: { input: document.getElementById('wb-preset-freq-penalty'), valueEl: document.getElementById('wb-preset-freq-penalty-value') }, presence_penalty: { input: document.getElementById('wb-preset-presence-penalty'), valueEl: document.getElementById('wb-preset-presence-penalty-value') }, };

        function renderWbMainHub() { const area = document.getElementById('wb-main-content-area'); area.innerHTML = ''; const allContent = [...globalState.worldBooks.map(item => ({ ...item, type: 'worldbook' })), ...globalState.presets.map(item => ({ ...item, type: 'preset' }))]; globalState.contentGroups.forEach(groupName => { const groupEl = document.createElement('div'); groupEl.className = 'content-group'; if (globalState.contentExpandedGroups.includes(groupName)) groupEl.classList.add('expanded'); const itemsInGroup = allContent.filter(item => item.group === groupName); if (itemsInGroup.length === 0) return; let cardsHTML = itemsInGroup.map(item => { const itemCount = item.type === 'worldbook' ? Object.keys(item.entries || {}).length : (item.prompts || []).length; const itemLabel = item.type === 'worldbook' ? '条目数' : '提示词数'; return `<div class="hub-card" data-id="${item.id}" data-type="${item.type}"><h4 class="card-title">${item.name}</h4><p class="card-description">${item.description}</p><div class="card-footer"><span>${itemLabel}: ${itemCount}</span></div></div>`; }).join(''); groupEl.innerHTML = `<h3 class="group-header" data-group-name="${groupName}"><span>${groupName}</span><span class="toggle-arrow">▼</span></h3><div class="card-container">${cardsHTML}</div>`; area.appendChild(groupEl); }); }
        function renderEntryList(bookId) { const book = globalState.worldBooks.find(b => b.id === bookId); if (!book) return; document.getElementById('wb-entry-list-title').textContent = book.name; const area = document.getElementById('wb-entry-list-content'); area.innerHTML = ''; const entries = Object.values(book.entries || {}).sort((a, b) => (a.order || 100) - (b.order || 100)); if (entries.length === 0) { area.innerHTML = '<p style="text-align:center; color: var(--text-light-fixed); padding-top: 20px;">点击右上角 + 新建条目</p>'; return; } entries.forEach(entry => { const card = document.createElement('div'); card.className = 'entry-card'; card.dataset.uid = entry.uid; card.innerHTML = `<h4 class="card-title">${entry.comment || '无注释'}</h4><p class="card-description">${(entry.content || '').substring(0, 100).replace(/\\n/g, ' ')}...</p><div class="card-footer"><span>ID: ${entry.uid}</span><span class="card-tag ${entry.disable ? 'disabled' : ''}">${entry.disable ? '已禁用' : '已启用'}</span></div>`; area.appendChild(card); }); }
        function renderPromptList(presetId) { const preset = globalState.presets.find(p => p.id === presetId); if (!preset) return; document.getElementById('wb-prompt-list-title').textContent = preset.name; const area = document.getElementById('wb-prompt-list-content'); area.innerHTML = ''; const prompts = preset.prompts || []; if (prompts.length === 0) { area.innerHTML = '<p style="text-align:center; color: var(--text-light-fixed); padding-top: 20px;">点击右上角 + 新建提示词</p>'; return; } prompts.forEach(prompt => { const card = document.createElement('div'); card.className = 'entry-card'; card.dataset.uid = prompt.identifier; card.innerHTML = `<h4 class="card-title">${prompt.name || '无名称'}</h4><p class="card-description">${(prompt.content || '').substring(0, 100).replace(/\\n/g, ' ')}...</p><div class="card-footer"><span>ID: ${prompt.identifier}</span><span class="card-tag ${prompt.enabled === false ? 'disabled' : ''}">${prompt.enabled === false ? '已禁用' : '已启用'}</span></div>`; area.appendChild(card); }); }
        
        function openWbBookEditor(bookId) {
            globalState.currentBookId = bookId;
            globalState.currentPresetId = null;
            globalState.currentWbContext = 'worldbook';
            const title = document.getElementById('wb-book-editor-title');
            const nameInput = document.getElementById('wb-book-name');
            const groupSelect = document.getElementById('wb-book-group');
            const descTextarea = document.getElementById('wb-book-description');
            const deleteContainer = document.getElementById('wb-delete-book-container');

            groupSelect.innerHTML = globalState.contentGroups.map(g => `<option value="${g}">${g}</option>`).join('');

            if (bookId === 'new') {
                title.textContent = "新建世界书";
                nameInput.value = "";
                descTextarea.value = "";
                groupSelect.value = "未分组";
                deleteContainer.style.display = 'none';
            } else {
                const book = globalState.worldBooks.find(b => b.id === bookId);
                if (!book) { console.error('World book not found:', bookId); goBack(); return; }
                title.textContent = "编辑世界书";
                nameInput.value = book.name;
                descTextarea.value = book.description;
                groupSelect.value = book.group;
                deleteContainer.style.display = 'block';
            }
            showPage('wb-book-editor-page');
        }

        function saveWbBook() { const name = document.getElementById('wb-book-name').value.trim(); if (!name) { alert("世界书名称不能为空！"); return; } const group = document.getElementById('wb-book-group').value, description = document.getElementById('wb-book-description').value; if (globalState.currentBookId === 'new') { globalState.worldBooks.push({ id: `wb_${Date.now()}`, name, description, group, entries: {} }); } else { const book = globalState.worldBooks.find(b => b.id === globalState.currentBookId); if (book) Object.assign(book, {name, group, description}); } renderWbMainHub(); goBack(); }
        function openWbEntryEditor(uid) { globalState.currentEntryUid = uid; const isPresetPrompt = globalState.currentWbContext === 'preset'; entryEditorFields.worldbookOnlyFields.style.display = isPresetPrompt ? 'none' : 'block'; entryEditorFields.commentLabel.textContent = isPresetPrompt ? '名称 (Name)' : '注释 (Comment)'; const container = isPresetPrompt ? globalState.presets.find(p => p.id === globalState.currentPresetId) : globalState.worldBooks.find(b => b.id === globalState.currentBookId); const items = isPresetPrompt ? (container.prompts || []) : (container.entries || {}); const item = isPresetPrompt ? items.find(p => p.identifier === uid) : items[uid]; if (uid === 'new') { entryEditorFields.title.textContent = isPresetPrompt ? "新建提示词" : "新建条目"; ['comment', 'content', 'keys', 'position', 'order', 'depth', 'probability'].forEach(key => entryEditorFields[key].value = ''); ['enabled', 'constant', 'selective', 'preventRecursion', 'useProbability'].forEach(key => entryEditorFields[key].checked = false); entryEditorFields.enabled.checked = true; entryEditorFields.order.value = 100; entryEditorFields.depth.value = 4; entryEditorFields.probability.value = 100; entryEditorFields.position.value = "4"; } else { const comment = isPresetPrompt ? item.name : item.comment; entryEditorFields.title.textContent = `编辑: ${(comment || '').substring(0, 10)}...`; entryEditorFields.comment.value = comment || ''; entryEditorFields.content.value = item.content || ''; entryEditorFields.enabled.checked = isPresetPrompt ? (item.enabled !== false) : !item.disable; entryEditorFields.constant.checked = item.constant || false; entryEditorFields.selective.checked = item.selective || false; if (!isPresetPrompt) { entryEditorFields.keys.value = (item.key || []).join(', '); entryEditorFields.position.value = item.position ?? 4; entryEditorFields.order.value = item.order ?? 100; entryEditorFields.depth.value = item.depth ?? 4; entryEditorFields.probability.value = item.probability ?? 100; entryEditorFields.preventRecursion.checked = item.preventRecursion || false; entryEditorFields.useProbability.checked = item.useProbability || false; } } showPage('wb-entry-editor-page'); }
        function saveWbEntry() { const isPresetPrompt = globalState.currentWbContext === 'preset'; const container = isPresetPrompt ? globalState.presets.find(p => p.id === globalState.currentPresetId) : globalState.worldBooks.find(b => b.id === globalState.currentBookId); const comment = entryEditorFields.comment.value.trim(); if (!comment) { alert((isPresetPrompt ? "名称" : "注释") + "不能为空！"); return; } const uid = (globalState.currentEntryUid === 'new') ? (isPresetPrompt ? `prompt_${Date.now()}` : `entry_${Date.now()}`) : globalState.currentEntryUid; if (isPresetPrompt) { const newPrompt = { identifier: uid, name: comment, content: entryEditorFields.content.value, enabled: entryEditorFields.enabled.checked, constant: entryEditorFields.constant.checked, selective: entryEditorFields.selective.checked, }; if (globalState.currentEntryUid === 'new') { container.prompts = container.prompts || []; container.prompts.push(newPrompt); } else { const index = container.prompts.findIndex(p => p.identifier === uid); if (index > -1) container.prompts[index] = { ...container.prompts[index], ...newPrompt }; } renderPromptList(globalState.currentPresetId); } else { container.entries[uid] = { uid, comment, content: entryEditorFields.content.value, key: entryEditorFields.keys.value.split(',').map(k => k.trim()).filter(Boolean), position: parseInt(entryEditorFields.position.value), order: parseInt(entryEditorFields.order.value), depth: parseInt(entryEditorFields.depth.value), probability: parseInt(entryEditorFields.probability.value), disable: !entryEditorFields.enabled.checked, constant: entryEditorFields.constant.checked, selective: entryEditorFields.selective.checked, preventRecursion: entryEditorFields.preventRecursion.checked, useProbability: entryEditorFields.useProbability.checked, }; renderEntryList(globalState.currentBookId); } goBack(); }
        function openWbPresetEditor(presetId) { globalState.currentPresetId = presetId; globalState.currentBookId = null; globalState.currentWbContext = 'preset'; const title = document.getElementById('wb-preset-editor-title'); const deleteContainer = document.getElementById('wb-delete-preset-container'); presetEditorFields.group.innerHTML = globalState.contentGroups.map(g => `<option value="${g}">${g}</option>`).join(''); if (presetId === 'new') { title.textContent = "新建预设"; presetEditorFields.name.value = ""; presetEditorFields.description.value = ""; presetEditorFields.group.value = "未分组"; Object.values(presetEditorFields).forEach(field => { if (field.input) { const defaultValue = field.input.getAttribute('value'); field.input.value = defaultValue; field.valueEl.textContent = defaultValue; } }); globalState.pendingPresetData = createDefaultPresetData(); deleteContainer.style.display = 'none'; } else { const preset = globalState.presets.find(p => p.id === presetId); if (!preset) { console.error('Preset not found:', presetId); goBack(); return; } title.textContent = "编辑预设"; presetEditorFields.name.value = preset.name; presetEditorFields.group.value = preset.group; presetEditorFields.description.value = preset.description; updateSlider(presetEditorFields.temperature, preset.temperature, 1.0); updateSlider(presetEditorFields.max_context, preset.openai_max_context, 4096); updateSlider(presetEditorFields.top_p, preset.top_p, 1.0); updateSlider(presetEditorFields.top_k, preset.top_k, 0); updateSlider(presetEditorFields.freq_penalty, preset.frequency_penalty, 0); updateSlider(presetEditorFields.presence_penalty, preset.presence_penalty, 0); deleteContainer.style.display = 'block'; } showPage('wb-preset-editor-page'); }
        function openWbPresetEditorWithData(data, fileName) { globalState.currentPresetId = 'new'; globalState.currentBookId = null; globalState.currentWbContext = 'preset'; globalState.pendingPresetData = data; document.getElementById('wb-preset-editor-title').textContent = "新建预设 (从文件导入)"; presetEditorFields.group.innerHTML = globalState.contentGroups.map(g => `<option value="${g}">${g}</option>`).join(''); presetEditorFields.name.value = fileName.replace('.json', ''); presetEditorFields.description.value = "从JSON文件导入"; presetEditorFields.group.value = "未分组"; updateSlider(presetEditorFields.temperature, data.temperature, 1.0); updateSlider(presetEditorFields.max_context, data.openai_max_context, 4096); updateSlider(presetEditorFields.top_p, data.top_p, 1.0); updateSlider(presetEditorFields.top_k, data.top_k, 0); updateSlider(presetEditorFields.freq_penalty, data.frequency_penalty, 0); updateSlider(presetEditorFields.presence_penalty, data.presence_penalty, 0); showPage('wb-preset-editor-page'); }
        function saveWbPreset() { const name = presetEditorFields.name.value.trim(); if (!name) { alert("预设名称不能为空！"); return; } const data = { name, group: presetEditorFields.group.value, description: presetEditorFields.description.value, temperature: parseFloat(presetEditorFields.temperature.input.value), openai_max_context: parseInt(presetEditorFields.max_context.input.value), top_p: parseFloat(presetEditorFields.top_p.input.value), top_k: parseInt(presetEditorFields.top_k.input.value), frequency_penalty: parseFloat(presetEditorFields.freq_penalty.input.value), presence_penalty: parseFloat(presetEditorFields.presence_penalty.input.value), }; if (globalState.currentPresetId === 'new') { const prompts = globalState.pendingPresetData ? globalState.pendingPresetData.prompts : []; const prompt_order = globalState.pendingPresetData ? globalState.pendingPresetData.prompt_order : []; globalState.presets.push({ id: `ps_${Date.now()}`, ...data, prompts: prompts || [], prompt_order: prompt_order || [] }); globalState.pendingPresetData = null; } else { const preset = globalState.presets.find(p => p.id === globalState.currentPresetId); if(preset) Object.assign(preset, data); } renderWbMainHub(); goBack(); }
        function updateSlider(field, value, defaultValue) { const val = value ?? defaultValue; field.input.value = val; field.valueEl.textContent = val; }
        function createDefaultPresetData() { const identifiers = [{ id: 'main', name: '主系统提示', enabled: true }, { id: 'worldInfoBefore', name: '世界信息 (前置)', enabled: true }, { id: 'charDescription', name: '角色描述', enabled: true }, { id: 'charPersonality', name: '角色性格', enabled: true }, { id: 'scenario', name: '场景', enabled: true }, { id: 'worldInfoAfter', name: '世界信息 (后置)', enabled: true }, { id: 'dialogueExamples', name: '对话示例', enabled: true }, { id: 'chatHistory', name: '聊天记录', enabled: true }, { id: 'jailbreak', name: '指令/越狱', enabled: true },]; const prompts = identifiers.map(item => ({ identifier: item.id, name: item.name, content: `[${item.name} Placeholder]`, enabled: true, system_prompt: true, marker: true, })); const prompt_order = identifiers.map(item => ({ identifier: item.id, enabled: item.enabled })); return { prompts, prompt_order }; }
        function renderWbGroupManager() { const area = document.getElementById('wb-group-manager-content'); area.innerHTML = ''; const allContent = [...globalState.worldBooks.map(i=>({...i, type:'worldbook'})), ...globalState.presets.map(i=>({...i, type:'preset'}))]; globalState.contentGroups.forEach(groupName => { const isDefault = groupName === '未分组'; const itemsInGroup = allContent.filter(item => item.group === groupName); const itemsHTML = itemsInGroup.map(item => `<div class="group-manage-content-item" data-id="${item.id}" data-type="${item.type}"><span>${item.name}</span></div>`).join(''); const groupDiv = document.createElement('div'); groupDiv.className = 'group-manage-item'; groupDiv.innerHTML = `<div class="group-manage-header"><h3 data-group-name="${groupName}" ${isDefault ? '' : 'class="clickable"'}>${groupName}</h3>${!isDefault ? `<button class="action-button-generic delete-group-btn" data-group-name="${groupName}" aria-label="删除分组"><svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>` : ''}</div><div class="group-manage-content">${itemsInGroup.length > 0 ? itemsHTML : '<p style="font-size:0.85em; color:var(--text-light-fixed); text-align:center; padding: 10px 0;">此分组下无项目</p>'}</div>`; area.appendChild(groupDiv); }); }

        function init() {
            document.getElementById('dock-icon-3-trigger').addEventListener('click', () => { renderWbMainHub(); showPage('wb-main-hub-page'); });
            pages.mainHub.addEventListener('click', (e) => { const target = e.target, closest = (selector) => target.closest(selector); if (closest('.group-header')) { const groupName = closest('.group-header').dataset.groupName; const index = globalState.contentExpandedGroups.indexOf(groupName); if (index > -1) globalState.contentExpandedGroups.splice(index, 1); else globalState.contentExpandedGroups.push(groupName); closest('.content-group').classList.toggle('expanded'); } else if (closest('.hub-card')) { const card = closest('.hub-card'), id = card.dataset.id, type = card.dataset.type; globalState.currentWbContext = type; if (type === 'worldbook') { globalState.currentBookId = id; globalState.currentPresetId = null; renderEntryList(id); showPage('wb-entry-list-page'); } else if (type === 'preset') { globalState.currentPresetId = id; globalState.currentBookId = null; renderPromptList(id); showPage('wb-prompt-list-page'); } } });
            pages.entryList.addEventListener('click', (e) => { const target = e.target; if (target.closest('#wb-new-entry-button')) openWbEntryEditor('new'); else if (target.closest('.entry-card')) openWbEntryEditor(target.closest('.entry-card').dataset.uid); else if (target.closest('#wb-entry-list-title')) openWbBookEditor(globalState.currentBookId); });
            pages.promptList.addEventListener('click', (e) => { const target = e.target; if (target.closest('#wb-new-prompt-button')) openWbEntryEditor('new'); else if (target.closest('.entry-card')) openWbEntryEditor(target.closest('.entry-card').dataset.uid); else if (target.closest('#wb-prompt-list-title')) openWbPresetEditor(globalState.currentPresetId); });
            document.getElementById('wb-save-book-button').addEventListener('click', saveWbBook); 
            document.getElementById('wb-save-preset-button').addEventListener('click', saveWbPreset); 
            document.getElementById('wb-save-entry-button').addEventListener('click', saveWbEntry);
            document.getElementById('wb-delete-book-button').addEventListener('click', async () => { const book = globalState.worldBooks.find(b => b.id === globalState.currentBookId); if (!book) return; const result = await showPrompt({ title: '删除确认', html: `<p>确定要删除世界书 “<strong>${book.name}</strong>” 吗？<br>所有绑定此世界书的角色将会被解绑。此操作不可撤销。</p>`, confirmText: '删除', confirmClass: 'btn-danger' }); if (result) { globalState.worldBooks = globalState.worldBooks.filter(b => b.id !== book.id); globalState.characters.forEach(char => { if (char.boundWorldBookId === book.id) char.boundWorldBookId = ""; }); renderWbMainHub(); showPage('wb-main-hub-page'); } });
            document.getElementById('wb-delete-preset-button').addEventListener('click', async () => { const preset = globalState.presets.find(p => p.id === globalState.currentPresetId); if (!preset) return; const result = await showPrompt({ title: '删除确认', html: `<p>确定要删除预设 “<strong>${preset.name}</strong>” 吗？<br>此操作不可撤销。</p>`, confirmText: '删除', confirmClass: 'btn-danger' }); if (result) { globalState.presets = globalState.presets.filter(p => p.id !== preset.id); renderWbMainHub(); showPage('wb-main-hub-page'); } });
            const addMenu = document.getElementById('wb-add-menu'); document.getElementById('wb-add-button').addEventListener('click', (e) => { e.stopPropagation(); addMenu.classList.toggle('visible'); }); window.addEventListener('click', () => { if (addMenu.classList.contains('visible')) addMenu.classList.remove('visible'); });
            const jsonFileInput = document.getElementById('wb-json-file-input'); document.getElementById('wb-upload-json-btn').addEventListener('click', (e) => { e.preventDefault(); addMenu.classList.remove('visible'); jsonFileInput.click(); }); jsonFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const parsedData = JSON.parse(event.target.result); const isPreset = parsedData.prompts && parsedData.hasOwnProperty('temperature'), isWorldBook = parsedData.entries; if (isPreset) { openWbPresetEditorWithData(parsedData, file.name); } else if (isWorldBook) { const result = await showPrompt({ title: `上传世界书`, html: `<div class="form-group"><label for="prompt-name">名称</label><input type="text" id="prompt-name" class="input-field" value="${file.name.replace('.json','')}"></div><div class="form-group"><label for="prompt-group">分组</label><select id="prompt-group" class="input-field">${globalState.contentGroups.map(g=>`<option>${g}</option>`).join('')}</select></div><div class="form-group"><label for="prompt-description">简介</label><textarea id="prompt-description" class="input-field">由JSON文件导入。</textarea></div>` }); if (result && result.name) { globalState.worldBooks.push({ id: `wb_${Date.now()}`, name: result.name, group: result.group, description: result.description, entries: parsedData.entries }); renderWbMainHub(); } } else { alert("无法识别的JSON文件格式！"); } } catch (error) { alert("解析JSON失败！"); console.error(error); } }; reader.readAsText(file); e.target.value = ''; });
            document.getElementById('wb-custom-book-btn').addEventListener('click', (e) => { e.preventDefault(); addMenu.classList.remove('visible'); openWbBookEditor('new'); }); document.getElementById('wb-custom-preset-btn').addEventListener('click', (e) => { e.preventDefault(); addMenu.classList.remove('visible'); openWbPresetEditor('new'); });
            Object.values(presetEditorFields).forEach(field => { if (field.input && field.input.type === 'range') field.input.addEventListener('input', (e) => { field.valueEl.textContent = e.target.value; }); });
            document.getElementById('wb-manage-groups-btn').addEventListener('click', (e) => { e.preventDefault(); addMenu.classList.remove('visible'); renderWbGroupManager(); showPage('wb-group-manager-page'); });
            pages.groupManager.addEventListener('click', async (e) => { const target = e.target; if(target.closest('#wb-add-new-group-btn')) { const { name } = await showPrompt({title: "新建分组", html: `<input type="text" id="prompt-name" class="input-field" placeholder="请输入分组名称">`}) || {}; if (name && !globalState.contentGroups.includes(name)) { globalState.contentGroups.push(name); renderWbGroupManager(); } } else if(target.closest('.delete-group-btn')) { const groupName = target.closest('.delete-group-btn').dataset.groupName; if (groupName === '未分组') { alert('默认分组不能删除！'); return; } if (confirm(`确定要删除分组 “${groupName}” 吗？\n该分组下的所有项目将被移至“未分组”。`)) { [...globalState.worldBooks, ...globalState.presets].forEach(item => { if (item.group === groupName) item.group = '未分组'; }); globalState.contentGroups = globalState.contentGroups.filter(g => g !== groupName); renderWbGroupManager(); renderWbMainHub(); } } else if(target.closest('.group-manage-content-item')) { const itemEl = target.closest('.group-manage-content-item'); const itemId = itemEl.dataset.id; const itemType = itemEl.dataset.type; const item = itemType === 'worldbook' ? globalState.worldBooks.find(i=>i.id===itemId) : globalState.presets.find(i=>i.id===itemId); const { group } = await showPrompt({ title: `移动 “${item.name}”`, html: `<label for="prompt-group">选择新分组</label><select id="prompt-group" class="input-field">${globalState.contentGroups.map(g=>`<option value="${g}" ${g===item.group ? 'selected' : ''}>${g}</option>`).join('')}</select>` }) || {}; if (group) { item.group = group; renderWbGroupManager(); renderWbMainHub(); } } else if(target.closest('.group-manage-header h3')) { const h3 = target.closest('.group-manage-header h3'); const oldName = h3.dataset.groupName; if (oldName === '未分组') return; const { name: newName } = await showPrompt({ title: `重命名分组`, html: `<input type="text" id="prompt-name" class="input-field" value="${oldName}">` }) || {}; if (newName && oldName !== newName && !globalState.contentGroups.includes(newName)) { const index = globalState.contentGroups.indexOf(oldName); globalState.contentGroups[index] = newName; [...globalState.worldBooks, ...globalState.presets].forEach(item => { if (item.group === oldName) item.group = newName; }); renderWbGroupManager(); renderWbMainHub(); } else if (newName && oldName !== newName) { alert('分组名称已存在或无效！'); } } });
        }
        return { init, renderWbMainHub };
    })();

    // --- 8. 全局初始化与事件绑定 ---
    function globalInit() {
        desktopLogic.init(); apiConfigLogic.init(); charBookLogic.init(); worldBookLogic.init();
        document.querySelectorAll('.back-button-generic').forEach(btn => btn.addEventListener('click', goBack));
        globalModals.editModal.save.addEventListener('click', () => { if (globalModals.editModal.onSaveCallback) globalModals.editModal.onSaveCallback(globalModals.editModal.input.value); closeEditModal(); });
        globalModals.editModal.cancel.addEventListener('click', closeEditModal);
        globalModals.editModal.overlay.addEventListener('click', (e) => { if (e.target === globalModals.editModal.overlay) closeEditModal(); });
        globalModals.prompt.confirmBtn.addEventListener('click', () => { const prompt = globalModals.prompt; if (!prompt.resolve) return; const inputs = prompt.content.querySelectorAll('input, select, textarea'); const result = {}; let isNameInvalid = false; inputs.forEach(input => { const key = input.id.replace('prompt-', ''); result[key] = input.value; if (key === 'name' && !input.value.trim()) isNameInvalid = true; }); if (isNameInvalid) { alert("名称不能为空!"); return; } if(result.name) result.name = result.name.trim(); const pResolve = prompt.resolve; prompt.resolve = null; hidePrompt(); pResolve(result); });
        globalModals.prompt.cancelBtn.addEventListener('click', hidePrompt);
        globalModals.prompt.overlay.addEventListener('click', (e) => { if (e.target === globalModals.prompt.overlay) hidePrompt(); });
        updateTime(); setInterval(updateTime, 30000); updateBatteryStatus(); apiConfigLogic.updateApiStatusIndicator(false);
    }
    function updateTime() { const now = new Date(); const timeDisplay = document.getElementById('current-time'); if (timeDisplay) timeDisplay.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; }
    function updateBatteryStatus() { if ('getBattery' in navigator) { navigator.getBattery().then(function(battery) { const container = document.getElementById('battery-container'); function updateAll() { container.classList.toggle('battery-charging', battery.charging); container.classList.toggle('battery-low', !battery.charging && battery.level <= 0.2); updateBatteryLevel(battery.level); } updateAll(); battery.addEventListener('chargingchange', updateAll); battery.addEventListener('levelchange', updateAll); }); } else { updateBatteryLevel(0.88); } }
    function updateBatteryLevel(level) { const fill = document.getElementById('battery-fill'); if(fill) fill.setAttribute('width', String(Math.max(2, Math.floor(22 * level)))); }
    
    globalInit();
});
</script>
</body>
</html>